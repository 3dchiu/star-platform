<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login â€“ Star</title>
  <link rel="stylesheet" href="../styles/main.css" />
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script type="module" src="../js/i18n.js"></script>
</head>
<body>
  <div id="appHeader"></div>
  <main class="container">
    <h2 id="welcomeTitle" data-i18n="login.welcomeTitle"></h2>
    <!-- ğŸ” ç™»å…¥å€ --> 
    <div id="loginSection">
      <form id="loginForm" novalidate>
        <input type="email"  id="loginEmail" class="login-input" placeholder="Email"    required />
        <input type="password" id="loginPassword" class="login-input" placeholder="Password" required />
        <button type="submit" class="login-input btn btn-primary">Login</button>
      </form>
      <p><a href="#" id="resetPassword">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</a></p>
      <p>é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ<a href="#" id="showRegister">è¨»å†Š</a></p>
    </div>

    <!-- ğŸ†• è¨»å†Šè¡¨å–®ï¼ˆé è¨­éš±è—ï¼‰ -->
    <div id="registerSection" style="display: none;">
      <form id="registerForm">
        <input type="email" id="registerEmail" placeholder="Email" required />
        <input type="password" id="registerPassword" placeholder="Password" required />
        <button type="submit">Register</button>
      </form>
      <p>å·²ç¶“æœ‰å¸³è™Ÿäº†ï¼Ÿ<a href="#" id="showLogin">è¿”å›ç™»å…¥</a></p>
    </div>

    <!-- éŒ¯èª¤æˆ–è¨Šæ¯é¡¯ç¤º -->
  <div id="error-message" style="color: red; display: none;"></div>
</main>
<!-- â†‘ çµ±ä¸€å¯¬åº¦å®¹å™¨ çµæŸ â†‘ -->
  <script>
  // â€”â€” å¦‚æœæœ‰é å­˜çš„ Emailï¼Œå°±åŒæ™‚å¡«å…¥ loginEmail å’Œ registerEmail â€”â€” 
  const prefillEmail = sessionStorage.getItem("prefillEmail");
  if (prefillEmail) {
    // ç™»å…¥æ¬„ä½
    const loginInput = document.getElementById("loginEmail");
    if (loginInput) loginInput.value = prefillEmail;
    // è¨»å†Šæ¬„ä½
    const registerInput = document.getElementById("registerEmail");
    if (registerInput) registerInput.value = prefillEmail;
    // æ¸…æ‰ï¼Œé¿å…ä¸‹æ¬¡åˆè‡ªå‹•å¸¶å…¥
    sessionStorage.removeItem("prefillEmail");
  }
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

    const firebaseConfig = {
      apiKey: "AIzaSyBp_XEBrLGAtOkSL9re9K5P0WgPumueuOA",
      authDomain: "star-platform-bf3e7.firebaseapp.com",
      projectId: "star-platform-bf3e7",
      storageBucket: "star-platform-bf3e7.appspot.com",
      messagingSenderId: "965516728684",
      appId: "1:965516728684:web:8f8648cb424a4434a37b49",
      measurementId: "G-X54H7KXE5Y"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginForm = document.getElementById("loginForm");
    const resetPasswordLink = document.getElementById("resetPassword");
    const errorMessage = document.getElementById("error-message");

    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          console.log("ç™»å…¥æˆåŠŸ");
          const params = new URLSearchParams(location.search);
          const next = params.get("next") || "profile-dashboard.html";
          location.href = next;
        })
        .catch((error) => {
          console.error("ç™»å…¥å¤±æ•—:", error);
          errorMessage.style.display = "block";
          errorMessage.textContent = `ç™»å…¥å¤±æ•—ï¼š${error.code} - ${error.message}`;
          if (error.code === "auth/invalid-email") {
            errorMessage.textContent = "Email æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹æª¢æŸ¥ã€‚";
          } else if (error.code === "auth/user-not-found") {
            errorMessage.textContent = "å¸³è™Ÿä¸å­˜åœ¨ï¼Œè«‹è¨»å†Šã€‚";
          } else if (error.code === "auth/wrong-password") {
            errorMessage.textContent = "å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦æˆ–é‡ç½®å¯†ç¢¼ã€‚";
          } else if (error.code === "auth/too-many-requests") {
            errorMessage.textContent = "è«‹æ±‚éå¤šï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
          } else {
            errorMessage.textContent = `ç™»å…¥å¤±æ•—ï¼š${error.message}`;
          }
        });
    });

    resetPasswordLink.addEventListener("click", (e) => {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value;
      if (!email) {
        errorMessage.style.display = "block";
        errorMessage.textContent = "è«‹è¼¸å…¥ Email ä»¥é‡ç½®å¯†ç¢¼ã€‚";
        return;
      }
      auth.sendPasswordResetEmail(email, {
        url: "https://star-platform-bf3e7.firebaseapp.com/pages/login.html"
      })
        .then(() => {
          errorMessage.style.display = "block";
          errorMessage.textContent = "é‡ç½®å¯†ç¢¼éƒµä»¶å·²ç™¼é€ï¼Œè«‹æª¢æŸ¥æ‚¨çš„éƒµç®±ï¼š" + email;
        })
        .catch((error) => {
          console.error("ç™¼é€é‡ç½®å¯†ç¢¼éƒµä»¶å¤±æ•—:", error);
          errorMessage.style.display = "block";
          errorMessage.textContent = `ç„¡æ³•ç™¼é€é‡ç½®å¯†ç¢¼éƒµä»¶ï¼š${error.code} - ${error.message}`;
        });
    });

   // ğŸ” å€å¡Šåˆ‡æ›é‚è¼¯
  document.getElementById("showRegister").addEventListener("click", (e) => {
    e.preventDefault();
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("registerSection").style.display = "block";
    errorMessage.style.display = "none";
  });

  document.getElementById("showLogin").addEventListener("click", (e) => {
    e.preventDefault();
    document.getElementById("registerSection").style.display = "none";
    document.getElementById("loginSection").style.display = "block";
    errorMessage.style.display = "none";
  });

  // ğŸ†• è¨»å†Šæµç¨‹
  const registerForm = document.getElementById("registerForm");
  registerForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const email = document.getElementById("registerEmail").value;
    const password = document.getElementById("registerPassword").value;

    auth.createUserWithEmailAndPassword(email, password)
      .then(async (userCredential) => {
        console.log("è¨»å†ŠæˆåŠŸ");
        const uid = userCredential.user.uid;
        // å…ˆæŠŠ email + name éƒ½å¯«é€² users/{uid}
    // ä¸€ã€å…ˆæŠ“ 1 ç­†ï¼Œåš name åˆä½µ
    let pendingSnap = await db
      .collection("pendingUsers")
      .where("email", "==", email)
      .limit(1)
      .get();

    if (!pendingSnap.empty) {
      const recommenderData = pendingSnap.docs[0].data();
      await db.collection("users").doc(uid).set({
        email: email,
        name:  recommenderData.name || ""
      }, { merge: true });
    } else {
      await db.collection("users").doc(uid).set({ email }, { merge: true });
    }

    // äºŒã€å†æŠ“æ‰€æœ‰åŒ emailï¼Œå†æ¬ç§»
    pendingSnap = await db
      .collection("pendingUsers")
      .where("email", "==", email)
      .get();

    for (const docSnap of pendingSnap.docs) {
      const data = docSnap.data();
      await db
        .collection("users")
        .doc(data.invitedBy)
        .collection("recommendations")
        .add({
          name:          data.name          || "",
          email:         data.email         || "",
          relation:      data.relation      || "",
          highlights:    data.highlights    || [],
          content:       data.content       || "",
          inviteMessage: data.inviteMessage || "",
          jobId:         data.jobId         || "",
          invitedBy:     uid,
          createdAt:     firebase.firestore.FieldValue.serverTimestamp()
        });
      await db.collection("pendingUsers").doc(docSnap.id).delete();
    }

    // 4ï¸âƒ£ æ¬å®Œä»¥å¾Œï¼Œå°å‘ Dashboardï¼ˆæˆ–ä½ è¦çš„é é¢ï¼‰
    window.location.href = "profile-dashboard.html";
  })

      .catch((error) => {
        errorMessage.style.display = "block";
        if (error.code === "auth/email-already-in-use") {
          errorMessage.textContent = "æ­¤ Email å·²è¢«è¨»å†Šï¼Œè«‹ç›´æ¥ç™»å…¥ã€‚";
        } else if (error.code === "auth/invalid-email") {
          errorMessage.textContent = "Email æ ¼å¼ä¸æ­£ç¢ºã€‚";
        } else if (error.code === "auth/weak-password") {
          errorMessage.textContent = "å¯†ç¢¼å¤ªç°¡å–®ï¼Œè«‹è‡³å°‘è¼¸å…¥ 6 å­—å…ƒã€‚";
        } else {
          errorMessage.textContent = `è¨»å†Šå¤±æ•—ï¼š${error.message}`;
        }
      });
    });
</script>
<script type="module" src="../js/components/app-header.js"></script>
<script type="module">
  import { setLang } from "../js/i18n.js";
  const lang = localStorage.getItem("lang") || "en";
  setLang(lang);
</script>
</body>
</html>