<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login â€“ Galaxyz</title>
  <link rel="stylesheet" href="../styles/main.css" />
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script type="module" src="../js/i18n.js"></script>
</head>
<body>
  <div id="appHeader"></div>
  <main class="container">
    <h2 id="welcomeTitle" data-i18n="login.welcomeTitle"></h2>
    <!-- ğŸ” ç™»å…¥å€ --> 
    <div id="loginSection">
      <form id="loginForm" novalidate>
        <input type="email"  id="loginEmail" class="login-input" placeholder="Email" required />
        <input type="password" id="loginPassword" class="login-input" placeholder="Password" required />
        <button type="submit" class="login-input btn btn-primary">Login</button>
      </form>
      <p id="registerReminder" style="color:#cc0000; margin-top: 12px;"></p>

      <p><a href="#" id="resetPassword">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</a></p>
      <p id="showRegisterRow" style="display:none">
        <span id="noAccountText"></span><br />
        <small id="registerOnlyNote"></small>
      </p>      
    </div>

    <!-- ğŸ†• è¨»å†Šè¡¨å–®ï¼ˆé è¨­éš±è—ï¼‰ -->
    <div id="registerSection" style="display: none;">
      <form id="registerForm">
        <input type="email" id="registerEmail" placeholder="Email" required />
        <input type="password" id="registerPassword" placeholder="Password" required />
        <!-- ğŸ« æ´»å‹•é‚€è«‹ç¢¼æ¬„ä½ï¼ˆé¸å¡«ï¼‰ -->
        <input type="text" id="inviteCodeInput" placeholder="é‚€è«‹ç¢¼ï¼ˆè‹¥æœ‰ï¼‰" />
        <small style="color: gray; display: block; margin-bottom: 12px;">
          åƒèˆ‡æ´»å‹•è€…è«‹å¡«å¯«å°ˆå±¬é‚€è«‹ç¢¼ï¼Œä¾‹å¦‚ galaxyz12345
        </small>
        <button id="registerBtn" type="submit">Register</button>
      </form>
      <p>å·²ç¶“æœ‰å¸³è™Ÿäº†ï¼Ÿ<a href="#" id="showLogin">è¿”å›ç™»å…¥</a></p>
    </div>

    <!-- éŒ¯èª¤æˆ–è¨Šæ¯é¡¯ç¤º -->
    <div id="error-message" style="color: red; display: none;"></div>
  </main>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyBp_XEBrLGAtOkSL9re9K5P0WgPumueuOA",
    authDomain: "star-platform-bf3e7.firebaseapp.com",
    projectId: "star-platform-bf3e7",
    storageBucket: "star-platform-bf3e7.appspot.com",
    messagingSenderId: "965516728684",
    appId: "1:965516728684:web:8f8648cb424a4434a37b49",
    measurementId: "G-X54H7KXE5Y"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const params = new URLSearchParams(location.search);

  // âœ… æ ¹æ“š email åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºè¨»å†Šé¸é …
  const prefillEmail = sessionStorage.getItem("prefillEmail");
  if (prefillEmail) {
    document.getElementById("loginEmail").value = prefillEmail;
    document.getElementById("registerEmail").value = prefillEmail;
    sessionStorage.removeItem("prefillEmail");
  }
  // âœ… åŠ å…¥ email é©—è­‰ï¼Œæ±ºå®šè¦é¡¯ç¤ºç™»å…¥é‚„æ˜¯è¨»å†Š
  const urlEmail = params.get("email");
  const inviteCode = params.get("inviteCode");
  const isRegister = params.get("register") === "1";

  // âœ… ä¸‰ç¨®æƒ…å¢ƒéƒ½é›†ä¸­è™•ç†
  if (isRegister) {
  const showRegisterForm = async () => {
    const registerSection = document.getElementById("registerSection");
    const loginSection = document.getElementById("loginSection");
    const showRegisterRow = document.getElementById("showRegisterRow");
    const registerReminder = document.getElementById("registerReminder");

    // âœ… å¦‚æœå¸¶æœ‰ inviteCodeï¼Œå„ªå…ˆè™•ç†æ´»å‹•è¨»å†Š
    if (inviteCode) {
      try {
        const codeSnap = await db.collection("inviteCodes").doc(inviteCode).get();
        if (codeSnap.exists && codeSnap.data().isActive === true) {
          // âœ… æˆåŠŸï¼Œé¡¯ç¤ºè¨»å†Šè¡¨å–®
          registerSection.style.display = "block";
          loginSection.style.display = "none";
          showRegisterRow.style.display = "block";
          document.getElementById("inviteCodeInput").value = inviteCode;
          return;
        } else {
          registerReminder.innerText = "é‚€è«‹ç¢¼ç„¡æ•ˆæˆ–å·²éæœŸï¼Œè«‹ç¢ºèªå¾Œå†è©¦ã€‚";
        }
      } catch (err) {
        console.error("âŒ é©—è­‰é‚€è«‹ç¢¼æ™‚ç™¼ç”ŸéŒ¯èª¤", err);
        registerReminder.innerText = "ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      }
    }

    // âœ… å¦‚æœå¸¶æœ‰ emailï¼Œè™•ç†æ¨è–¦äººè¨»å†Š
    if (urlEmail) {
      const userSnap = await db.collection("users").where("email", "==", urlEmail).limit(1).get();
      if (!userSnap.empty) {
        location.href = `/pages/login.html?email=${encodeURIComponent(urlEmail)}`;
        return;
      }

      const pendingSnap = await db.collection("pendingUsers").where("email", "==", urlEmail).limit(1).get();
      if (!pendingSnap.empty) {
        registerSection.style.display = "block";
        loginSection.style.display = "none";
        showRegisterRow.style.display = "block";
        document.getElementById("registerEmail").value = urlEmail;
        document.getElementById("registerEmail").readOnly = true;
        return;
      }
    }

      // âœ… å…è¨±ä½¿ç”¨è€…æ‰‹å‹•è¼¸å…¥é‚€è«‹ç¢¼ï¼ˆç´”é‚€è«‹è¨»å†Šæƒ…å¢ƒï¼‰
      registerSection.style.display = "block";
      loginSection.style.display = "none";
      showRegisterRow.style.display = "block";
      // ä¸å¸¶ emailï¼Œä¸å¯é å¡«
  };

  showRegisterForm();
}


  loginForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;
    const errorMessage = document.getElementById("error-message");

    auth.signInWithEmailAndPassword(email, password)
      .then(() => {
        const next = params.get("next") || "profile-dashboard.html";
        location.href = next;
      })
      .catch((error) => {
        errorMessage.style.display = "block";
        errorMessage.textContent = error.message;
      });
  });
  const resetPasswordLink = document.getElementById("resetPassword");
  resetPasswordLink.addEventListener("click", (e) => {
    e.preventDefault();
    const email = document.getElementById("loginEmail").value;
    if (!email) {
      errorMessage.style.display = "block";
      errorMessage.textContent = "è«‹è¼¸å…¥ Email ä»¥é‡ç½®å¯†ç¢¼ã€‚";
      return;
    }
    auth.sendPasswordResetEmail(email, { url: location.href })
      .then(() => {
        errorMessage.style.display = "block";
        errorMessage.textContent = "é‡ç½®å¯†ç¢¼éƒµä»¶å·²ç™¼é€ï¼Œè«‹æª¢æŸ¥æ‚¨çš„éƒµç®±ï¼š" + email;
      })
      .catch((error) => {
        errorMessage.style.display = "block";
        errorMessage.textContent = error.message;
      });
  });

  const registerForm = document.getElementById("registerForm");
  registerForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const errorMessage = document.getElementById("error-message");
  const email = document.getElementById("registerEmail").value.trim();
  const password = document.getElementById("registerPassword").value;
  const inviteCode = document.getElementById("inviteCodeInput").value.trim();
  const name = "";
  const registerBtn = document.getElementById("registerBtn");

  console.log("ğŸ§ª æº–å‚™è¨»å†Š emailï¼š", email, "é‚€è«‹ç¢¼ï¼š", inviteCode);

  if (!email) {
    errorMessage.style.display = "block";
    errorMessage.textContent = "Email æ¬„ä½ç‚ºå¿…å¡«ï¼Œè«‹é‡æ–°å¡«å¯«ã€‚";
    registerBtn.disabled = false;
    registerBtn.innerText = "Register";
    return;
  }

  // ğŸ” æª¢æŸ¥æ˜¯å¦ç‚º pendingUser æˆ–é‚€è«‹ç¢¼æœ‰æ•ˆ
  let allowRegister = false;

  try {
    const pendingSnap = await db.collection("pendingUsers").where("email", "==", email).get();
    if (!pendingSnap.empty) {
      allowRegister = true;
    }

    if (!allowRegister && inviteCode) {
      const codeDoc = await db.collection("inviteCodes").doc(inviteCode).get();
      if (codeDoc.exists && codeDoc.data().isActive === true) {
        allowRegister = true;
      }
    }

    if (!allowRegister) {
      errorMessage.style.display = "block";
      errorMessage.textContent = "æ‚¨å°šæœªè¢«æ¨è–¦ï¼Œä¸”é‚€è«‹ç¢¼ç„¡æ•ˆï¼Œæš«æ™‚ç„¡æ³•è¨»å†Šã€‚";
      return;
    }
  } catch (err) {
    console.error("âŒ è¨»å†Šå‰é©—è­‰éŒ¯èª¤", err);
    errorMessage.style.display = "block";
    errorMessage.textContent = "ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
    return;
  }

  // âœ… é€šéé©—è­‰å¾Œç¹¼çºŒè¨»å†Š
  registerBtn.disabled = true;
  registerBtn.innerText = "Registering...";

  auth.createUserWithEmailAndPassword(email, password)
    .then(async (userCredential) => {
      console.log("âœ… è¨»å†ŠæˆåŠŸ", userCredential);  // âœ… åŠ é€™è¡Œ
      try {
        await auth.currentUser.getIdToken(true);  // âœ… ç­‰å¾… auth ç‹€æ…‹åŒæ­¥
        const uid = userCredential.user.uid;
        const snapshot = await db.collection("pendingUsers").where("email", "==", email).get();
        for (const doc of snapshot.docs) {
          const data = doc.data();

          console.log("ğŸ§ª å¯«å…¥ users æ™‚ä½¿ç”¨çš„ emailï¼š", email);
          // ğŸ” å»ºç«‹ user profile è³‡æ–™
          const userData = {
            email: email,
            name: "",
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          };

          // âœ… è‹¥ä½¿ç”¨äº† inviteCodeï¼Œå¯«é€² userData
          if (inviteCode) {
            userData.inviteCode = inviteCode;

          // ğŸ” å°‡ inviteCodes/{inviteCode}.usageCount + 1
            const inviteRef = db.collection("inviteCodes").doc(inviteCode);
            const inviteSnap = await inviteRef.get();
            if (inviteSnap.exists) {
              const currentCount = inviteSnap.data().usageCount || 0;
              await inviteRef.update({
                usageCount: currentCount + 1
              });
            } 
          }

          await db.collection("users").doc(uid).set(userData, { merge: true });

          await doc.ref.delete();
        }
        window.location.href = "profile-dashboard.html";
      } catch (err) {
        console.error("ğŸ”¥ è¨»å†ŠæˆåŠŸä½† Firestore å¯«å…¥éŒ¯èª¤ï¼š", err);
        errorMessage.style.display = "block";
        errorMessage.textContent = "å¸³è™Ÿå·²å»ºç«‹ï¼Œä½†è³‡æ–™å„²å­˜ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚";
      }
    })
    .catch((error) => {
      console.error("âŒ è¨»å†Šå¤±æ•—", error);  // âœ… åŠ é€™è¡Œ
      registerBtn.disabled = false;
      registerBtn.innerText = "Register";

      errorMessage.style.display = "block";
      errorMessage.textContent = error.message;
    });
  });
  </script>
  <script type="module" src="../js/components/app-header.js"></script>
  <script type="module">
    import { setLang, i18n } from "../js/i18n.js";
    const lang = localStorage.getItem("lang") || "en";
    setLang(lang);
  
    window.addEventListener("DOMContentLoaded", () => {
      const t = i18n[lang]?.login || {};
      const params = new URLSearchParams(location.search);
      const email = params.get("email");
      //const loginForm = document.getElementById("loginForm"); // ä¸è¦é‡è¤‡å®£å‘Šï¼Œå› ç‚ºä¸Šé¢å·²ç¶“ const å®£å‘Šéäº†
      const resetPasswordLink = document.getElementById("resetPassword");
      const errorMessage = document.getElementById("error-message");
  
      // ğŸŒ åˆå§‹èªè¨€é¡¯ç¤ºæ–‡å­—
      document.getElementById("welcomeTitle").innerText = t.welcomeTitle || "";
      document.getElementById("noAccountText").innerHTML = t.noAccountText || "";
      document.getElementById("registerOnlyNote").innerText = t.registerOnlyNote || "";
      document.getElementById("resetPassword").innerText = t.resetPassword || "";
      document.getElementById("registerReminder").innerText = t.registerReminder || "";
  
      // ğŸ‘€ æ ¹æ“šç¶²å€åƒæ•¸é¡¯ç¤ºè¨»å†Šè¡¨å–®
      //if (params.get("register") === "1" && email) {
      //  document.getElementById("registerEmail").value = email;
      //  document.getElementById("registerEmail").readOnly = true;
      //  document.getElementById("loginSection").style.display = "none";
      //  document.getElementById("registerSection").style.display = "block";
      //  document.getElementById("showRegisterRow").style.display = "block";
    //  }
      const showLoginBtn = document.getElementById("showLogin");
      if (showLoginBtn) {
        showLoginBtn.addEventListener("click", (e) => {
          e.preventDefault();
          document.getElementById("registerSection").style.display = "none";
          document.getElementById("loginSection").style.display = "block";
          errorMessage.style.display = "none";
        });
      }
    });
  
    // ğŸŒ å¤šèªåˆ‡æ›æ™‚æ›´æ–°ç•«é¢
    window.addEventListener("langChanged", (e) => {
      const lang = e.detail || "en";
      const t = i18n[lang]?.login || {};
      document.getElementById("welcomeTitle").innerText = t.welcomeTitle || "";
      document.getElementById("noAccountText").innerHTML = t.noAccountText || "";
      document.getElementById("registerOnlyNote").innerText = t.registerOnlyNote || "";
      document.getElementById("resetPassword").innerText = t.resetPassword || "";
      document.getElementById("registerReminder").innerText = t.registerReminder || "";
    });
  </script>  
</body>
</html>
