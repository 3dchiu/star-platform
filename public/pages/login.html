<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login – Galaxyz</title>
  <link rel="stylesheet" href="../styles/main.css" />
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script type="module" src="../js/i18n.js"></script>
</head>
<body>
  <div id="appHeader"></div>
  <main class="container">
    <h2 id="welcomeTitle" data-i18n="login.welcomeTitle"></h2>
    <!-- 🔐 登入區 --> 
    <div id="loginSection">
      <form id="loginForm" novalidate>
        <input type="email"  id="loginEmail" class="login-input" placeholder="Email" required />
        <input type="password" id="loginPassword" class="login-input" placeholder="Password" required />
        <button type="submit" class="login-input btn btn-primary">Login</button>
      </form>
      <p id="registerReminder" style="color:#cc0000; margin-top: 12px;"></p>

      <p><a href="#" id="resetPassword">忘記密碼？</a></p>
      <p id="showRegisterRow" style="display:none">
        <span id="noAccountText"></span><br />
        <small id="registerOnlyNote"></small>
      </p>      
    </div>

    <!-- 🆕 註冊表單（預設隱藏） -->
    <div id="registerSection" style="display: none;">
      <form id="registerForm">
        <input type="email" id="registerEmail" placeholder="Email" required />
        <input type="password" id="registerPassword" placeholder="Password" required />
        <!-- 🎫 活動邀請碼欄位（選填） -->
        <input type="text" id="inviteCodeInput" placeholder="邀請碼（若有）" />
        <small style="color: gray; display: block; margin-bottom: 12px;">
          參與活動者請填寫專屬邀請碼，例如 galaxyz12345
        </small>
        <button id="registerBtn" type="submit">Register</button>
      </form>
      <p>已經有帳號了？<a href="#" id="showLogin">返回登入</a></p>
    </div>

    <!-- 錯誤或訊息顯示 -->
    <div id="error-message" style="color: red; display: none;"></div>
  </main>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyBp_XEBrLGAtOkSL9re9K5P0WgPumueuOA",
    authDomain: "star-platform-bf3e7.firebaseapp.com",
    projectId: "star-platform-bf3e7",
    storageBucket: "star-platform-bf3e7.appspot.com",
    messagingSenderId: "965516728684",
    appId: "1:965516728684:web:8f8648cb424a4434a37b49",
    measurementId: "G-X54H7KXE5Y"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const params = new URLSearchParams(location.search);

  // ✅ 根據 email 判斷是否顯示註冊選項
  const prefillEmail = sessionStorage.getItem("prefillEmail");
  if (prefillEmail) {
    document.getElementById("loginEmail").value = prefillEmail;
    document.getElementById("registerEmail").value = prefillEmail;
    sessionStorage.removeItem("prefillEmail");
  }
  // ✅ 加入 email 驗證，決定要顯示登入還是註冊
  const urlEmail = params.get("email");
  const inviteCode = params.get("inviteCode");
  const isRegister = params.get("register") === "1";

  // ✅ 三種情境都集中處理
  if (isRegister) {
  const showRegisterForm = async () => {
    const registerSection = document.getElementById("registerSection");
    const loginSection = document.getElementById("loginSection");
    const showRegisterRow = document.getElementById("showRegisterRow");
    const registerReminder = document.getElementById("registerReminder");

    // ✅ 如果帶有 inviteCode，優先處理活動註冊
    if (inviteCode) {
      try {
        const codeSnap = await db.collection("inviteCodes").doc(inviteCode).get();
        if (codeSnap.exists && codeSnap.data().isActive === true) {
          // ✅ 成功，顯示註冊表單
          registerSection.style.display = "block";
          loginSection.style.display = "none";
          showRegisterRow.style.display = "block";
          document.getElementById("inviteCodeInput").value = inviteCode;
          return;
        } else {
          registerReminder.innerText = "邀請碼無效或已過期，請確認後再試。";
        }
      } catch (err) {
        console.error("❌ 驗證邀請碼時發生錯誤", err);
        registerReminder.innerText = "系統錯誤，請稍後再試。";
      }
    }

    // ✅ 如果帶有 email，處理推薦人註冊
    if (urlEmail) {
      const userSnap = await db.collection("users").where("email", "==", urlEmail).limit(1).get();
      if (!userSnap.empty) {
        location.href = `/pages/login.html?email=${encodeURIComponent(urlEmail)}`;
        return;
      }

      const pendingSnap = await db.collection("pendingUsers").where("email", "==", urlEmail).limit(1).get();
      if (!pendingSnap.empty) {
        registerSection.style.display = "block";
        loginSection.style.display = "none";
        showRegisterRow.style.display = "block";
        document.getElementById("registerEmail").value = urlEmail;
        document.getElementById("registerEmail").readOnly = true;
        return;
      }
    }

      // ✅ 允許使用者手動輸入邀請碼（純邀請註冊情境）
      registerSection.style.display = "block";
      loginSection.style.display = "none";
      showRegisterRow.style.display = "block";
      // 不帶 email，不可預填
  };

  showRegisterForm();
}


  loginForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;
    const errorMessage = document.getElementById("error-message");

    auth.signInWithEmailAndPassword(email, password)
      .then(() => {
        const next = params.get("next") || "profile-dashboard.html";
        location.href = next;
      })
      .catch((error) => {
        errorMessage.style.display = "block";
        errorMessage.textContent = error.message;
      });
  });
  const resetPasswordLink = document.getElementById("resetPassword");
  resetPasswordLink.addEventListener("click", (e) => {
    e.preventDefault();
    const email = document.getElementById("loginEmail").value;
    if (!email) {
      errorMessage.style.display = "block";
      errorMessage.textContent = "請輸入 Email 以重置密碼。";
      return;
    }
    auth.sendPasswordResetEmail(email, { url: location.href })
      .then(() => {
        errorMessage.style.display = "block";
        errorMessage.textContent = "重置密碼郵件已發送，請檢查您的郵箱：" + email;
      })
      .catch((error) => {
        errorMessage.style.display = "block";
        errorMessage.textContent = error.message;
      });
  });

  const registerForm = document.getElementById("registerForm");
  registerForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const errorMessage = document.getElementById("error-message");
  const email = document.getElementById("registerEmail").value.trim();
  const password = document.getElementById("registerPassword").value;
  const inviteCode = document.getElementById("inviteCodeInput").value.trim();
  const name = "";
  const registerBtn = document.getElementById("registerBtn");

  console.log("🧪 準備註冊 email：", email, "邀請碼：", inviteCode);

  if (!email) {
    errorMessage.style.display = "block";
    errorMessage.textContent = "Email 欄位為必填，請重新填寫。";
    registerBtn.disabled = false;
    registerBtn.innerText = "Register";
    return;
  }

  // 🔍 檢查是否為 pendingUser 或邀請碼有效
  let allowRegister = false;

  try {
    const pendingSnap = await db.collection("pendingUsers").where("email", "==", email).get();
    if (!pendingSnap.empty) {
      allowRegister = true;
    }

    if (!allowRegister && inviteCode) {
      const codeDoc = await db.collection("inviteCodes").doc(inviteCode).get();
      if (codeDoc.exists && codeDoc.data().isActive === true) {
        allowRegister = true;
      }
    }

    if (!allowRegister) {
      errorMessage.style.display = "block";
      errorMessage.textContent = "您尚未被推薦，且邀請碼無效，暫時無法註冊。";
      return;
    }
  } catch (err) {
    console.error("❌ 註冊前驗證錯誤", err);
    errorMessage.style.display = "block";
    errorMessage.textContent = "系統錯誤，請稍後再試。";
    return;
  }

  // ✅ 通過驗證後繼續註冊
  registerBtn.disabled = true;
  registerBtn.innerText = "Registering...";

  auth.createUserWithEmailAndPassword(email, password)
    .then(async (userCredential) => {
      console.log("✅ 註冊成功", userCredential);  // ✅ 加這行
      try {
        await auth.currentUser.getIdToken(true);  // ✅ 等待 auth 狀態同步
        const uid = userCredential.user.uid;
        const snapshot = await db.collection("pendingUsers").where("email", "==", email).get();
        for (const doc of snapshot.docs) {
          const data = doc.data();

          console.log("🧪 寫入 users 時使用的 email：", email);
          // 🔍 建立 user profile 資料
          const userData = {
            email: email,
            name: "",
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          };

          // ✅ 若使用了 inviteCode，寫進 userData
          if (inviteCode) {
            userData.inviteCode = inviteCode;

          // 🔁 將 inviteCodes/{inviteCode}.usageCount + 1
            const inviteRef = db.collection("inviteCodes").doc(inviteCode);
            const inviteSnap = await inviteRef.get();
            if (inviteSnap.exists) {
              const currentCount = inviteSnap.data().usageCount || 0;
              await inviteRef.update({
                usageCount: currentCount + 1
              });
            } 
          }

          await db.collection("users").doc(uid).set(userData, { merge: true });

          await doc.ref.delete();
        }
        window.location.href = "profile-dashboard.html";
      } catch (err) {
        console.error("🔥 註冊成功但 Firestore 寫入錯誤：", err);
        errorMessage.style.display = "block";
        errorMessage.textContent = "帳號已建立，但資料儲存發生錯誤，請聯絡管理員。";
      }
    })
    .catch((error) => {
      console.error("❌ 註冊失敗", error);  // ✅ 加這行
      registerBtn.disabled = false;
      registerBtn.innerText = "Register";

      errorMessage.style.display = "block";
      errorMessage.textContent = error.message;
    });
  });
  </script>
  <script type="module" src="../js/components/app-header.js"></script>
  <script type="module">
    import { setLang, i18n } from "../js/i18n.js";
    const lang = localStorage.getItem("lang") || "en";
    setLang(lang);
  
    window.addEventListener("DOMContentLoaded", () => {
      const t = i18n[lang]?.login || {};
      const params = new URLSearchParams(location.search);
      const email = params.get("email");
      //const loginForm = document.getElementById("loginForm"); // 不要重複宣告，因為上面已經 const 宣告過了
      const resetPasswordLink = document.getElementById("resetPassword");
      const errorMessage = document.getElementById("error-message");
  
      // 🌐 初始語言顯示文字
      document.getElementById("welcomeTitle").innerText = t.welcomeTitle || "";
      document.getElementById("noAccountText").innerHTML = t.noAccountText || "";
      document.getElementById("registerOnlyNote").innerText = t.registerOnlyNote || "";
      document.getElementById("resetPassword").innerText = t.resetPassword || "";
      document.getElementById("registerReminder").innerText = t.registerReminder || "";
  
      // 👀 根據網址參數顯示註冊表單
      //if (params.get("register") === "1" && email) {
      //  document.getElementById("registerEmail").value = email;
      //  document.getElementById("registerEmail").readOnly = true;
      //  document.getElementById("loginSection").style.display = "none";
      //  document.getElementById("registerSection").style.display = "block";
      //  document.getElementById("showRegisterRow").style.display = "block";
    //  }
      const showLoginBtn = document.getElementById("showLogin");
      if (showLoginBtn) {
        showLoginBtn.addEventListener("click", (e) => {
          e.preventDefault();
          document.getElementById("registerSection").style.display = "none";
          document.getElementById("loginSection").style.display = "block";
          errorMessage.style.display = "none";
        });
      }
    });
  
    // 🌐 多語切換時更新畫面
    window.addEventListener("langChanged", (e) => {
      const lang = e.detail || "en";
      const t = i18n[lang]?.login || {};
      document.getElementById("welcomeTitle").innerText = t.welcomeTitle || "";
      document.getElementById("noAccountText").innerHTML = t.noAccountText || "";
      document.getElementById("registerOnlyNote").innerText = t.registerOnlyNote || "";
      document.getElementById("resetPassword").innerText = t.resetPassword || "";
      document.getElementById("registerReminder").innerText = t.registerReminder || "";
    });
  </script>  
</body>
</html>
