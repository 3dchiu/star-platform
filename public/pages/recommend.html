<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- 分頁標題 (會由 JS 動態更新) -->
  <title id="pageTitle">Recommendation Summary</title>

  <!-- 1. 全站主樣式 -->
  <link rel="stylesheet" href="../styles/main.css" />

  <!-- 2. Print.js (如果未來有列印需求) -->
  <link rel="stylesheet" href="https://printjs-4de6.kxcdn.com/print.min.css" />
  <script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>

  <!-- 3. 多語 i18n 腳本 (module) -->
  <script type="module" src="../js/i18n.js"></script>

  <!-- 4. Header 插入腳本 (module) -->
  <script type="module" src="../js/components/app-header.js"></script>
</head>

<body>
  <!-- Header 容器 -->
  <div id="appHeader"></div>

  <!-- 主要內容容器 -->
  <main class="container">
    <!-- 標題 -->
    <h1 id="experienceTitle"></h1>

    <!-- 個人資料 -->
    <div id="profileArea"></div>

    <!-- 工作經歷列表 -->
    <div id="workList"></div>

    <!-- 新增工作經歷按鈕 -->
    <button id="addButton" class="btn btn-primary"></button>

    <!-- 列印區 (隱藏) -->
    <div id="printArea"></div>
  </main>

  <!-- 腳本：i18n + 內容注入 + 互動邏輯 -->
  <script>
    const i18n = {
      "en": {
        profileTitle: "Profile",
        experienceTitle: "Work Experiences (Grouped by Company, Sorted by Most Recent)",
        nameNative: "Name (in your native language):",
        nameEnglish: "Name in English:",
        placeholderInvite: "Enter invitation message (optional)",
        copyLink: "🔗 Copy Link",
        delete: "🗑️ Delete",
        recommendations: "Recommendations:",
        noProfile: "Profile not found. Please create your profile first.",
        confirmDelete: "Are you sure you want to delete this work experience?",
        copied: "✅ Link with invitation message copied!",
        printTitle: "Recommendation Summary for",
        addExperience: "＋ Add Work Experience"
      },
      "zh-Hant": {
        profileTitle: "個人資料",
        experienceTitle: "工作經歷（依公司分組，時間由新到舊）",
        nameNative: "中文姓名：",
        nameEnglish: "英文姓名：",
        placeholderInvite: "輸入邀請語（選填）",
        copyLink: "🔗 複製推薦連結",
        delete: "🗑️ 刪除",
        recommendations: "推薦紀錄：",
        noProfile: "尚未建立個人資料。",
        confirmDelete: "確定要刪除這筆工作經歷嗎？",
        copied: "✅ 含邀請語的推薦連結已複製！",
        printTitle: "推薦總表：",
        addExperience: "＋ 新增工作經歷"
      }
    };

    // 取得當前語系
    const lang = localStorage.getItem("lang") || "en";
    const t = i18n[lang];

    document.addEventListener("DOMContentLoaded", () => {
      // 更新分頁標題和頁面 H1
      document.title = t.experienceTitle;
      document.getElementById("experienceTitle").innerText = t.experienceTitle;

      // 更新「新增工作經歷」按鈕文字
      const addBtn = document.getElementById("addButton");
      addBtn.innerText = t.addExperience;
      addBtn.addEventListener("click", () => {
        window.location.href = "add-experience.html";
      });

      // 讀取本地儲存的 profile
      const profile = JSON.parse(localStorage.getItem("profile")) || {};
      const profileArea = document.getElementById("profileArea");
      const workList    = document.getElementById("workList");

      // 如果沒有 profile，顯示提示並結束
      if (!profile.chineseName) {
        profileArea.innerHTML = `<p>${t.noProfile}</p>`;
        return;
      }

      // 顯示個人資料
      profileArea.innerHTML = `
        <p><strong>${t.nameNative}</strong> ${profile.chineseName}</p>
        <p><strong>${t.nameEnglish}</strong> ${profile.englishName}</p>
      `;

      // 按「開始日期」排序、再依公司分組
      const sorted = [...(profile.workExperiences || [])]
        .sort((a, b) => b.startDate.localeCompare(a.startDate));
      const grouped = {};
      sorted.forEach(job => {
        if (!grouped[job.company]) grouped[job.company] = [];
        grouped[job.company].push(job);
      });

      // 動態產生每個公司的區塊
      let idx = 0;
      for (const company in grouped) {
        const companyBlock = document.createElement("div");
        companyBlock.className = "entry";

        const title = document.createElement("h3");
        title.textContent = company;
        companyBlock.appendChild(title);

        grouped[company].forEach(job => {
          const jobDiv = document.createElement("div");
          jobDiv.className = "job";

          // 建立邀請訊息輸入框、複製、刪除按鈕
          const inputId = `invite-msg-${idx}`;
          jobDiv.innerHTML = `
            <span>– ${job.position} (${job.startDate} ～ ${job.endDate})</span>
            <input
              class="inviteMessageInput"
              id="${inputId}"
              placeholder="${t.placeholderInvite}"
            />
            <button class="btn btn-secondary copyBtn" data-index="${idx}">
              ${t.copyLink}
            </button>
            <button class="btn btn-secondary deleteBtn" data-index="${idx}">
              ${t.delete}
            </button>
          `;

          // 如果有推薦紀錄，顯示之
          if (job.recommendations?.length) {
            const recBlock = document.createElement("div");
            recBlock.className = "recommend-block";
            recBlock.innerHTML =
              `<strong>${t.recommendations}</strong><br>` +
              job.recommendations
                .map(r => `📝 ${r.name} (${r.relation}): ${r.content}`)
                .join("<br><br>");
            jobDiv.appendChild(recBlock);
          }

          companyBlock.appendChild(jobDiv);
          idx++;
        });

        workList.appendChild(companyBlock);
      }

      // 複製推薦連結
      document.querySelectorAll(".copyBtn").forEach(btn => {
        btn.addEventListener("click", e => {
          const i = e.target.dataset.index;
          const msg = encodeURIComponent(
            document.getElementById(`invite-msg-${i}`).value.trim()
          );
          const link = `${window.location.origin}/recommend-form.html?userId=${profile.userId}` +
                       `&jobIndex=${i}&message=${msg}`;
          navigator.clipboard.writeText(link)
            .then(() => alert(t.copied));
        });
      });

      // 刪除工作經歷
      document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.addEventListener("click", e => {
          const delIdx = +e.target.dataset.index;
          if (confirm(t.confirmDelete)) {
            // 重新過濾
            profile.workExperiences = profile.workExperiences.filter((_, j) => j !== delIdx);
            localStorage.setItem("profile", JSON.stringify(profile));
            location.reload();
          }
        });
      });
    });
  </script>
</body>
</html>
