<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- åˆ†é æ¨™é¡Œ (æœƒç”± JS å‹•æ…‹æ›´æ–°) -->
  <title id="pageTitle">Recommendation Summary</title>

  <!-- 1. å…¨ç«™ä¸»æ¨£å¼ -->
  <link rel="stylesheet" href="../styles/main.css" />

  <!-- 2. Print.js (å¦‚æœæœªä¾†æœ‰åˆ—å°éœ€æ±‚) -->
  <link rel="stylesheet" href="https://printjs-4de6.kxcdn.com/print.min.css" />
  <script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>

  <!-- 3. å¤šèª i18n è…³æœ¬ (module) -->
  <script type="module" src="../js/i18n.js"></script>

  <!-- 4. Header æ’å…¥è…³æœ¬ (module) -->
  <script type="module" src="../js/components/app-header.js"></script>
</head>

<body>
  <!-- Header å®¹å™¨ -->
  <div id="appHeader"></div>

  <!-- ä¸»è¦å…§å®¹å®¹å™¨ -->
  <main class="container">
    <!-- æ¨™é¡Œ -->
    <h1 id="experienceTitle"></h1>

    <!-- å€‹äººè³‡æ–™ -->
    <div id="profileArea"></div>

    <!-- å·¥ä½œç¶“æ­·åˆ—è¡¨ -->
    <div id="workList"></div>

    <!-- æ–°å¢å·¥ä½œç¶“æ­·æŒ‰éˆ• -->
    <button id="addButton" class="btn btn-primary"></button>

    <!-- åˆ—å°å€ (éš±è—) -->
    <div id="printArea"></div>
  </main>

  <!-- è…³æœ¬ï¼ši18n + å…§å®¹æ³¨å…¥ + äº’å‹•é‚è¼¯ -->
  <script>
    const i18n = {
      "en": {
        profileTitle: "Profile",
        experienceTitle: "Work Experiences (Grouped by Company, Sorted by Most Recent)",
        nameNative: "Name (in your native language):",
        nameEnglish: "Name in English:",
        placeholderInvite: "Enter invitation message (optional)",
        copyLink: "ğŸ”— Copy Link",
        delete: "ğŸ—‘ï¸ Delete",
        recommendations: "Recommendations:",
        noProfile: "Profile not found. Please create your profile first.",
        confirmDelete: "Are you sure you want to delete this work experience?",
        copied: "âœ… Link with invitation message copied!",
        printTitle: "Recommendation Summary for",
        addExperience: "ï¼‹ Add Work Experience"
      },
      "zh-Hant": {
        profileTitle: "å€‹äººè³‡æ–™",
        experienceTitle: "å·¥ä½œç¶“æ­·ï¼ˆä¾å…¬å¸åˆ†çµ„ï¼Œæ™‚é–“ç”±æ–°åˆ°èˆŠï¼‰",
        nameNative: "ä¸­æ–‡å§“åï¼š",
        nameEnglish: "è‹±æ–‡å§“åï¼š",
        placeholderInvite: "è¼¸å…¥é‚€è«‹èªï¼ˆé¸å¡«ï¼‰",
        copyLink: "ğŸ”— è¤‡è£½æ¨è–¦é€£çµ",
        delete: "ğŸ—‘ï¸ åˆªé™¤",
        recommendations: "æ¨è–¦ç´€éŒ„ï¼š",
        noProfile: "å°šæœªå»ºç«‹å€‹äººè³‡æ–™ã€‚",
        confirmDelete: "ç¢ºå®šè¦åˆªé™¤é€™ç­†å·¥ä½œç¶“æ­·å—ï¼Ÿ",
        copied: "âœ… å«é‚€è«‹èªçš„æ¨è–¦é€£çµå·²è¤‡è£½ï¼",
        printTitle: "æ¨è–¦ç¸½è¡¨ï¼š",
        addExperience: "ï¼‹ æ–°å¢å·¥ä½œç¶“æ­·"
      }
    };

    // å–å¾—ç•¶å‰èªç³»
    const lang = localStorage.getItem("lang") || "en";
    const t = i18n[lang];

    document.addEventListener("DOMContentLoaded", () => {
      // æ›´æ–°åˆ†é æ¨™é¡Œå’Œé é¢ H1
      document.title = t.experienceTitle;
      document.getElementById("experienceTitle").innerText = t.experienceTitle;

      // æ›´æ–°ã€Œæ–°å¢å·¥ä½œç¶“æ­·ã€æŒ‰éˆ•æ–‡å­—
      const addBtn = document.getElementById("addButton");
      addBtn.innerText = t.addExperience;
      addBtn.addEventListener("click", () => {
        window.location.href = "add-experience.html";
      });

      // è®€å–æœ¬åœ°å„²å­˜çš„ profile
      const profile = JSON.parse(localStorage.getItem("profile")) || {};
      const profileArea = document.getElementById("profileArea");
      const workList    = document.getElementById("workList");

      // å¦‚æœæ²’æœ‰ profileï¼Œé¡¯ç¤ºæç¤ºä¸¦çµæŸ
      if (!profile.chineseName) {
        profileArea.innerHTML = `<p>${t.noProfile}</p>`;
        return;
      }

      // é¡¯ç¤ºå€‹äººè³‡æ–™
      profileArea.innerHTML = `
        <p><strong>${t.nameNative}</strong> ${profile.chineseName}</p>
        <p><strong>${t.nameEnglish}</strong> ${profile.englishName}</p>
      `;

      // æŒ‰ã€Œé–‹å§‹æ—¥æœŸã€æ’åºã€å†ä¾å…¬å¸åˆ†çµ„
      const sorted = [...(profile.workExperiences || [])]
        .sort((a, b) => b.startDate.localeCompare(a.startDate));
      const grouped = {};
      sorted.forEach(job => {
        if (!grouped[job.company]) grouped[job.company] = [];
        grouped[job.company].push(job);
      });

      // å‹•æ…‹ç”¢ç”Ÿæ¯å€‹å…¬å¸çš„å€å¡Š
      let idx = 0;
      for (const company in grouped) {
        const companyBlock = document.createElement("div");
        companyBlock.className = "entry";

        const title = document.createElement("h3");
        title.textContent = company;
        companyBlock.appendChild(title);

        grouped[company].forEach(job => {
          const jobDiv = document.createElement("div");
          jobDiv.className = "job";

          // å»ºç«‹é‚€è«‹è¨Šæ¯è¼¸å…¥æ¡†ã€è¤‡è£½ã€åˆªé™¤æŒ‰éˆ•
          const inputId = `invite-msg-${idx}`;
          jobDiv.innerHTML = `
            <span>â€“ ${job.position} (${job.startDate} ï½ ${job.endDate})</span>
            <input
              class="inviteMessageInput"
              id="${inputId}"
              placeholder="${t.placeholderInvite}"
            />
            <button class="btn btn-secondary copyBtn" data-index="${idx}">
              ${t.copyLink}
            </button>
            <button class="btn btn-secondary deleteBtn" data-index="${idx}">
              ${t.delete}
            </button>
          `;

          // å¦‚æœæœ‰æ¨è–¦ç´€éŒ„ï¼Œé¡¯ç¤ºä¹‹
          if (job.recommendations?.length) {
            const recBlock = document.createElement("div");
            recBlock.className = "recommend-block";
            recBlock.innerHTML =
              `<strong>${t.recommendations}</strong><br>` +
              job.recommendations
                .map(r => `ğŸ“ ${r.name} (${r.relation}): ${r.content}`)
                .join("<br><br>");
            jobDiv.appendChild(recBlock);
          }

          companyBlock.appendChild(jobDiv);
          idx++;
        });

        workList.appendChild(companyBlock);
      }

      // è¤‡è£½æ¨è–¦é€£çµ
      document.querySelectorAll(".copyBtn").forEach(btn => {
        btn.addEventListener("click", e => {
          const i = e.target.dataset.index;
          const msg = encodeURIComponent(
            document.getElementById(`invite-msg-${i}`).value.trim()
          );
          const link = `${window.location.origin}/recommend-form.html?userId=${profile.userId}` +
                       `&jobIndex=${i}&message=${msg}`;
          navigator.clipboard.writeText(link)
            .then(() => alert(t.copied));
        });
      });

      // åˆªé™¤å·¥ä½œç¶“æ­·
      document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.addEventListener("click", e => {
          const delIdx = +e.target.dataset.index;
          if (confirm(t.confirmDelete)) {
            // é‡æ–°éæ¿¾
            profile.workExperiences = profile.workExperiences.filter((_, j) => j !== delIdx);
            localStorage.setItem("profile", JSON.stringify(profile));
            location.reload();
          }
        });
      });
    });
  </script>
</body>
</html>
