// ========================================
// 1Ô∏è‚É£ Â∏∏Êï∏ÂíåÂÖ®ÂüüËÆäÊï∏ÂÆöÁæ©
// ========================================
import { t } from '../i18n.js';

const LEVEL_MAP = {
    1: 0, 2: 10, 3: 25, 4: 50, 5: 100,
    6: 200, 7: 300, 8: 500, 9: 750, 10: 1000
};

// Firebase Áõ∏ÈóúËÆäÊï∏
let app, auth, db;

// ÂÖ®Âüü‰ΩøÁî®ËÄÖË≥áÊñô
window.profile = { userId:"", name:"", englishName:"", bio:"", workExperiences:[], recommendationStats: {} };

// Á∑®ËºØÁãÄÊÖãËÆäÊï∏
let editIdx, currentJobIndex, currentCompany, currentDefaultMsg, currentInviteStyle;

// ========================================
// 2Ô∏è‚É£ Â∑•ÂÖ∑ÂáΩÂºè
// ========================================

// üåç Áµ±‰∏ÄÁöÑÂ§öË™ûË®ÄÁç≤ÂèñÂáΩÊï∏
function getSafeI18n() {
    return window.i18n || {};
}

function getSafeTranslation(lang) {
    return getSafeI18n()[lang] || getSafeI18n()["zh-Hant"] || {};
}

// üåç Áç≤ÂèñÁï∂ÂâçË™ûË®ÄÁöÑÁøªË≠ØÂáΩÊï∏
function getCurrentTranslation() {
    const lang = localStorage.getItem("lang") || "zh-Hant";
    return getSafeTranslation(lang);
}

function getLevelInfo(exp, tFunc) {
    // üîß ‰øÆÂæ©ÔºöÁ≠âÁ¥öÂêçÁ®±ÊáâË©≤Âú®È†ÇÂ±§Ôºå‰∏çÂú® profileDashboard ‰∏ã
    const i18nKey = (level) => `level${level}_name`;
    
    // ‰ΩøÁî®È†ÇÂ±§ÁøªË≠ØÈçµÁç≤ÂèñÁ≠âÁ¥öÂêçÁ®±
    const getLevelName = (level) => {
        const currentLang = localStorage.getItem("lang") || "zh-Hant";
        const translations = getSafeTranslation(currentLang);
        const levelKey = `level${level}_name`;
        return translations[levelKey] || `Level ${level}`;
    };
    
    if (exp >= 1000) return { level: 10, name: getLevelName(10), color: "legendary" };
    if (exp >= 750)  return { level: 9,  name: getLevelName(9), color: "diamond" };
    if (exp >= 500)  return { level: 8,  name: getLevelName(8), color: "trophy" };
    if (exp >= 300)  return { level: 7,  name: getLevelName(7), color: "globe" };
    if (exp >= 200)  return { level: 6,  name: getLevelName(6), color: "sun" };
    if (exp >= 100)  return { level: 5,  name: getLevelName(5), color: "gold" };
    if (exp >= 50)   return { level: 4,  name: getLevelName(4), color: "rocket" };
    if (exp >= 25)   return { level: 3,  name: getLevelName(3), color: "handshake" };
    if (exp >= 10)   return { level: 2,  name: getLevelName(2), color: "briefcase" };
    return             { level: 1,  name: getLevelName(1), color: "gray" };
}

function getNextLevelThreshold(level) {
    return LEVEL_MAP[level + 1] ?? Infinity;
}

function getTranslationFunction() {
    const lang = localStorage.getItem("lang") || "en";
    return (key, ...args) => {
        try {
            const keys = key.split(".");
            let value = window.i18n?.[lang];

            for (const k of keys) {
                if (value && typeof value === 'object' && k in value) {
                    value = value[k];
                } else {
                    return key; 
                }
            }
            
            if (typeof value === 'function') {
                return value(...args);
            }
            
            // üëá„ÄêÊ†∏ÂøÉ‰øÆÊ≠£„Äë: Â¶ÇÊûú value ‰∏çÊòØÂ≠ó‰∏≤ÊàñÂáΩÂºè (‰æãÂ¶ÇÊòØÈô£ÂàóÊàñÁâ©‰ª∂)Ôºå
            // Áõ¥Êé•ËøîÂõû value Êú¨Ë∫´ÔºåËÄå‰∏çÊòØËøîÂõû key„ÄÇ
            return value; 

        } catch (e) {
            console.warn("ÁøªË≠ØÊôÇÁôºÁîüÈåØË™§:", key, e);
            return key;
        }
    };
}

// üÜï Áµ±‰∏ÄÁöÑ Modal ÁøªË≠ØÂà∑Êñ∞ÂáΩÊï∏
function forceRefreshModalTranslations(modalId = null) {
    // ÂÆöÁæ©ÊâÄÊúâÈúÄË¶ÅËôïÁêÜÁöÑÂΩàÁ™ó
    const allModals = [
        'profileEditModal',    // Á∑®ËºØÂÄã‰∫∫Ê™îÊ°à
        'expModal',           // Êñ∞Â¢û/Á∑®ËºØÂ∑•‰ΩúÁ∂ìÊ≠∑
        'replyOptionsModal',  // ÂõûË¶ÜÈÅ∏È†Ö
        'replyModal',         // ÂõûË¶ÜÂΩàÁ™ó
        'waitlistModal',      // Á≠âÂÄôÊ∏ÖÂñÆ
        'inviteModal',        // ÈÇÄË´ãÂΩàÁ™ó
        'onboardingModal'     // Êñ∞ÊâãÂºïÂ∞é
    ];
    
    const modalIds = modalId ? [modalId] : allModals;
    
    modalIds.forEach(id => {
        const modal = document.getElementById(id);
        if (!modal) {
            console.log(`‚ÑπÔ∏è Modal ${id} ‰∏çÂ≠òÂú®ÔºåË∑≥ÈÅé`);
            return;
        }

        console.log(`üîÑ [Áµ±‰∏Ä‰øÆÂæ©] Âà∑Êñ∞ ${id} ÁøªË≠Ø`);
        
        // Á¢∫‰øùÁøªË≠ØÂáΩÊï∏ÂèØÁî®
        const tFunc = window.t || ((key) => {
            console.warn(`‚ùå ÁøªË≠ØÂáΩÊï∏‰∏çÂèØÁî®ÔºåÈçµ: ${key}`);
            return key;
        });

        try {
            // 1. ËôïÁêÜÊ®ôÈ°åÔºàÂ§öÁ®ÆÈÅ∏ÊìáÂô®Ôºâ
            const titleSelectors = [
                'h3[data-i18n]',
                'h3#modalTitle', 
                '.modal-header h3',
                'h3',
                '[data-i18n*="Title"]'
            ];
            
            for (const selector of titleSelectors) {
                const titleEl = modal.querySelector(selector);
                if (titleEl) {
                    let titleKey = titleEl.getAttribute('data-i18n');
                    
                    if (!titleKey) {
                        const titleMapping = {
                            'profileEditModal': 'profileDashboard.editProfileTitle',
                            'expModal': 'profileDashboard.addExperienceTitle',
                            'replyOptionsModal': 'profileDashboard.replyOptions',
                            'replyModal': 'profileDashboard.selectColleagueToReply',
                            'waitlistModal': 'profileDashboard.waitlistTitle',
                            'inviteModal': 'profileDashboard.inviteModalTitle',
                            'onboardingModal': 'profileDashboard.onboardingModal.modalTitle'
                        };
                        titleKey = titleMapping[id];
                    }
                    
                    if (titleKey) {
                        const translation = tFunc(titleKey);
                        if (translation && translation !== titleKey) {
                            titleEl.textContent = translation;
                            console.log(`‚úÖ ${id} Ê®ôÈ°å: ${translation}`);
                            break;
                        }
                    }
                }
            }

            // 2. ËôïÁêÜÊâÄÊúâ data-i18n ÂÖÉÁ¥†
            modal.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (!key) return;
                
                const translation = tFunc(key);
                if (translation && translation !== key) {
                    el.textContent = translation;
                }
            });

            // 3. ËôïÁêÜ placeholder Â±¨ÊÄß
            modal.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (!key) return;
                
                const translation = tFunc(key);
                if (translation && translation !== key) {
                    el.placeholder = translation;
                }
            });

            // 4. ËôïÁêÜÊåâÈàïÊñáÂ≠ó
            modal.querySelectorAll('button[data-i18n]').forEach(btn => {
                const key = btn.getAttribute('data-i18n');
                if (!key) return;
                
                const translation = tFunc(key);
                if (translation && translation !== key) {
                    btn.textContent = translation;
                }
            });

            console.log(`‚úÖ [Áµ±‰∏Ä‰øÆÂæ©] ${id} ÁøªË≠ØÂà∑Êñ∞ÂÆåÊàê`);

        } catch (error) {
            console.error(`‚ùå [Áµ±‰∏Ä‰øÆÂæ©] ${id} ÁøªË≠ØÂà∑Êñ∞Â§±Êïó:`, error);
        }
    });
}

function showToast(msg) {
    const d = document.createElement("div");
    d.className = "toast";
    d.textContent = msg;
    document.body.appendChild(d);
    setTimeout(() => d.remove(), 3000);
}

// üöÄ Êô∫ËÉΩÈñãÂïüÂáΩÊï∏
function smartOpenRecommendation(url, linkType = 'recommendation') {
    console.log(`üéØ ${linkType}: ${t('profileDashboard.attemptingNewTab')} -> ${url}`);
    
    const newWindow = window.open(url, '_blank');
    
    setTimeout(() => {
        if (!newWindow || newWindow.closed || newWindow.location.href === 'about:blank') {
            console.log(`‚ùå ${linkType}: ${t('profileDashboard.newTabBlocked')}`);
            console.log(`üîÑ ${linkType}: ${t('profileDashboard.fallbackToSameWindow')}`);
            window.location.href = url;
        } else {
            console.log(`‚úÖ ${linkType}: ${t('profileDashboard.newTabSuccess')}`);
        }
    }, 150);
    
    return false;
}

// ========================================
// 3Ô∏è‚É£ UI Ê∏≤ÊüìÂáΩÂºè
// ========================================

// ‚ú® Á≠âÁ¥öË≥áË®äÊ∏≤Êüì
function renderUserLevel(exp) {
    const container = document.getElementById("userLevelInfo");
    if (!container) return;

    const currentLevelInfo = getLevelInfo(exp, t);
    const currentLevel = currentLevelInfo.level;
    const currentLevelName = currentLevelInfo.name;
    const currentLevelColor = currentLevelInfo.color;

    const currentLevelExp = LEVEL_MAP[currentLevel];
    const nextLevelExp = getNextLevelThreshold(currentLevel); 

    let progressPercentage = 0;
    if (nextLevelExp !== Infinity) {
        const expInCurrentLevel = exp - currentLevelExp;
        const expForNextLevel = nextLevelExp - currentLevelExp;
        progressPercentage = Math.max(0, Math.min(100, Math.floor((expInCurrentLevel / expForNextLevel) * 100)));
    } else {
        progressPercentage = 100;
    }

    const expToNextText = nextLevelExp !== Infinity 
        ? t('profileDashboard.upgradeHint', nextLevelExp - exp, currentLevel + 1)
        : t('profileDashboard.maxLevelReached');

    container.innerHTML = `
        <div class="level-badge-dashboard level-${currentLevelColor}">
            <div class="star-icon">‚òÖ</div>
            <span class="level-number">${currentLevel}</span>
        </div>
        <div class="level-details">
            <span class="level-name">${currentLevelName}</span>
            <div class="progress-bar">
                <div class="progress-bar-fill" style="width: ${progressPercentage}%;"></div>
            </div>
            <div class="exp-text">
                <span class="current-exp">EXP: ${exp} / ${nextLevelExp === Infinity ? t('profileDashboard.maxLevel') : nextLevelExp}</span>
                <span class="exp-to-next">${expToNextText}</span>
            </div>
        </div>
    `;
}

// ‚ú® Âü∫Êú¨Ë≥áË®äÊ∏≤Êüì
function renderBasicInfo(profile) {
    const container = document.getElementById('basicInfo');
    if (!container) return;

    const stats = window.profile.recommendationStats || {};
    const totalReceived = stats.totalReceived || 0;
    const totalGiven = stats.totalGiven || 0;
    
    let recommendationsNote = "";
    if (totalReceived > 0 || totalGiven > 0) {
        recommendationsNote = `
            <p class="rec-summary mt-2 text-sm text-gray-500">
                ${t('profileDashboard.received')} <strong>${totalReceived}</strong> ${t('profileDashboard.recommendations')} | ${t('profileDashboard.totalRecommended')} <strong>${totalGiven}</strong> ${t('profileDashboard.people')}
            </p>
        `;
    }

    let displayName = profile.name || "";
    if (profile.englishName) {
        displayName += ` (${profile.englishName})`;
    }

    const headlineHTML = profile.headline ? `<p class="text-gray-600 mt-1">${profile.headline}</p>` : "";
    
    container.innerHTML = `
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-2xl font-bold">${displayName}</h1>
                ${headlineHTML}
            </div>
            <button id="open-edit-modal-btn" class="icon-btn" title="${t('profileDashboard.editProfileTitle')}">&#9999;&#65039;</button>
        </div>
        ${recommendationsNote}
    `;
}

// ‚ú® ÂÄã‰∫∫Á∞°‰ªãÊ∏≤Êüì
function renderBioSection(profile) {
    const bioTextEl = document.getElementById('bioText');
    if (bioTextEl) {
        bioTextEl.innerHTML = profile.bio ? profile.bio.replace(/\n/g, "<br>") : t("profileDashboard.noBio");
    }
}

// ‚ú® Â∑•‰ΩúÁ∂ìÊ≠∑Âç°ÁâáÊ∏≤Êüì
function renderExperienceCardsWithReply(list, profile) { 
    list.innerHTML = "";
    const frag = document.createDocumentFragment();
    const grouped = {};
    
    const t = getTranslationFunction();

    profile.workExperiences.sort((a,b)=>b.startDate.localeCompare(a.startDate))
        .forEach(job=> (grouped[job.company] = grouped[job.company]||[]).push(job));

    Object.entries(grouped).forEach(([comp,jobs]) => {
        const wrap = document.createElement("div");
        wrap.className = "company-card";
        wrap.innerHTML = `<div class="company-title">${comp}</div>`;
        
        jobs.forEach(job => {
            const idx = profile.workExperiences.indexOf(job);
            
            const receivedCount = job.recCount || 0;
            const givenCount = job.givenCount || 0;
            const canReplyCount = job.canReplyCount || 0;
            const hasRec = receivedCount > 0;
            const pendingCount = job.pending || 0;
            const failedCount = job.failed || 0;

            const roleCard = document.createElement("div");
            roleCard.className = "role-card";

            roleCard.innerHTML = `
                <div class="role-header">
                    <div class="role-info">
                        <strong>${job.position}</strong>
                        <div class="work-period">${job.startDate} ÔΩû ${job.endDate || t("profileDashboard.currentlyWorking")}</div>
                    </div>
                    <div class="manage-actions">
                        <button class="manage-btn edit-btn" data-idx="${idx}" title="${t('profileDashboard.edit')}">üìù</button>
                        <button class="manage-btn del-btn" data-idx="${idx}" title="${t('profileDashboard.delete')}">üóëÔ∏è</button>
                    </div>
                </div>
                ${job.description ? `<div class="work-description">${job.description.replace(/\n/g, "<br>")}</div>` : ""}
            `;

            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'rec-summary-block';
            
            // ‚ú® --- Ê†∏ÂøÉ‰øÆÊîπÔºöÁ¨¨‰∏ÄÈÉ®ÂàÜ --- ‚ú®
            // ÊàëÂÄëÂ∞á„ÄåÁµ±Ë®àÊñáÂ≠ó„ÄçÂíå„ÄåÊìç‰ΩúÊåâÈàï„ÄçÁöÑ HTML ÂàÜÈñãÁî¢Áîü„ÄÇ
            
            let summaryTextHTML = '';
            
            // Ê≠•È©ü 1: Âè™ÊúâÂú®ÊúâÊî∂Âà∞Êé®Ëñ¶ÊôÇÔºåÊâçÁî¢ÁîüÁµ±Ë®àÊñáÂ≠óÂçÄÂ°ä„ÄÇ
            if (hasRec || (job.allReceived && job.allReceived > 0)) {
                const lang = localStorage.getItem("lang") || "zh-Hant";
                const unit = (count) => (lang === "zh-Hant" ? "‰Ωç" : (count === 1 ? "person" : "people"));
                
                let mainStatsText = hasRec ? `
                    <span class="stat-item">
                        ${t('profileDashboard.received')} <a href="/pages/recommend-summary.html?userId=${profile.userId}&jobId=${job.id}" onclick="return smartOpenRecommendation(this.href, 'Êé®Ëñ¶Á∏ΩË¶Ω')">
                            <strong>${receivedCount}</strong> ${t('profileDashboard.recommendations')}
                        </a>
                    </span>` : `
                    <span class="stat-item">
                        <span class="emoji">üì¨</span> ${t('profileDashboard.noRecommendation')}
                    </span>`;
                
                const replyStatsText = canReplyCount > 0 ? `<span class="stat-separator">|</span><span class="stat-item">${t('profileDashboard.canReply')} <strong>${canReplyCount}</strong> ${unit(canReplyCount)}</span>` : '';
                const givenStatsText = `<span class="stat-separator">|</span><span class="stat-item">${t('profileDashboard.totalRecommended')} <strong>${givenCount}</strong> ${unit(givenCount)}</span>`;

                let pendingHint = "";
                if (pendingCount > 0 && failedCount > 0) {
                // ÊÉÖÂ¢É‰∏âÔºöÂÖ©ËÄÖÈÉΩÊúâ
                    pendingHint = `<div class="pending-hint"><small>üí° ${t('profileDashboard.hintBoth', { pending: pendingCount, failed: failedCount })}</small></div>`;
                } else if (pendingCount > 0) {
                // ÊÉÖÂ¢É‰∏ÄÔºöÂè™Êúâ pending
                    pendingHint = `<div class="pending-hint"><small>üí° ${t('profileDashboard.hintPendingOnly', { count: pendingCount })}</small></div>`;
                } else if (failedCount > 0) {
                // ÊÉÖÂ¢É‰∫åÔºöÂè™Êúâ failed
                    pendingHint = `<div class="pending-hint"><small>üí° ${t('profileDashboard.hintFailedOnly', { count: failedCount })}</small></div>`;
                }
                
                const predefinedHighlights = new Set(['hardSkill', 'softSkill', 'character']);
                const highlightText = Object.entries(job.highlightCount || {}).map(([k, c]) => `${predefinedHighlights.has(k) ? t(`recommendSummary.highlight_${k}`) : k} ${c} ${unit(c)}`).join('„ÄÅ') || t('profileDashboard.noHighlights');
                
                const relOptions = t('recommendSummary.relationFilterOptions') || [];
                const relationText = Object.entries(job.relationCount || {}).map(([k, c]) => {
                    const match = relOptions.find(opt => opt.value === k);
                    return `${match ? match.label : k} ${c} ${unit(c)}`;
                }).join('„ÄÅ') || t('profileDashboard.noRelations');
                
                summaryTextHTML = `
                    <div class="summary-text">
                        <div class="recommendation-stats">${mainStatsText}${replyStatsText}${givenStatsText}</div>
                        ${pendingHint}
                        <p>${t('profileDashboard.highlights')}Ôºö${highlightText}</p>
                        <p>${t('profileDashboard.relations')}Ôºö${relationText}</p>
                    </div>
                `;

            } else {
                // Â¶ÇÊûúÊ≤íÊúâÊî∂Âà∞‰ªª‰ΩïÊé®Ëñ¶ÔºåÈ°ØÁ§∫‰∏ÄÊÆµÂºïÂ∞éÊñáÂ≠ó„ÄÇ
               summaryTextHTML = `
                <div class="summary-text no-recommendations-prompt">
                    <p>
                        <span class="emoji">üíå</span>
                        <strong>${t('profileDashboard.noRecsTitle')}</strong>
                    </p>
                    <ul style="list-style-type: disc; padding-left: 20px; margin-top: 8px; color: #555;">
                        <li>${t('profileDashboard.noRecsAction1')}</li>
                        <li>${t('profileDashboard.noRecsAction2')}</li>
                    </ul>
                </div>
            `;
            }

            // ‚ú® --- Ê†∏ÂøÉ‰øÆÊîπÔºöÁ¨¨‰∫åÈÉ®ÂàÜ --- ‚ú®
            // Ê≠•È©ü 2: ÁÑ°Ë´ñÂ¶Ç‰ΩïÔºåÈÉΩÁî¢ÁîüÊìç‰ΩúÊåâÈàïÁöÑÂçÄÂ°ä„ÄÇ
            const actionButtonsHTML = `
                <div class="recommendation-actions">
                    <button class="action-btn primary recommend-others-btn" data-idx="${idx}" title="${t('profileDashboard.recommendOthers')} (+10 EXP)">ü§ù ${t('profileDashboard.recommendOthers')}</button>
                    ${canReplyCount > 0 ? `<button class="action-btn secondary reply-btn" data-idx="${idx}" title="${t('profileDashboard.replyRecommend')} (+3 EXP)">üí¨ ${t('profileDashboard.replyRecommend')} (${canReplyCount})</button>` : ''}
                    <button class="action-btn secondary link-btn" data-idx="${idx}" title="${t('profileDashboard.inviteRecommender')} (${t('profileDashboard.successfulRecommendation')} +5 EXP)">üì® ${t('profileDashboard.inviteRecommender')}</button>
                </div>
            `;

            // Ê≠•È©ü 3: Â∞áÁµ±Ë®àÊñáÂ≠óÂíåÊìç‰ΩúÊåâÈàïÁµÑÂêàËµ∑‰æÜ„ÄÇ
            summaryDiv.innerHTML = `
                <hr style="border: none; border-top: 1px solid #ddd; margin: 16px 0;" />
                <div class="summary-content">
                    ${summaryTextHTML}
                    ${actionButtonsHTML}
                </div>`;
            
            roleCard.appendChild(summaryDiv);
            wrap.appendChild(roleCard);
        });
        frag.appendChild(wrap);
    });
    list.appendChild(frag);
}

// ‚ú® Êõ¥Êñ∞ÂºïÂ∞éÊñáÂ≠ó
function updateOnboardingText() {
    const onb = t('profileDashboard.onboarding') || { title: "Âø´ÈÄüÈñãÂßã ‚ú®", steps: [] };
    const titleEl = document.getElementById("onboardingTitle");
    const stepsEl = document.getElementById("onboardingSteps");
    if (titleEl) titleEl.innerText = onb.title;
    if (stepsEl) stepsEl.innerHTML = onb.steps.map(s => `<li>${s}</li>`).join("");
}

// ‚ú® Âπ¥ÊúàÈÅ∏È†ÖÁî¢Áîü
function populateYearMonth() {
    const now = new Date(), thisYear = now.getFullYear();
    let yrs = ['<option value="">--</option>'], mos = ['<option value="">--</option>'];
    
    // Áî¢ÁîüÂπ¥‰ªΩÈÅ∏È†Ö
    for (let y = thisYear; y >= thisYear - 40; y--) {
        yrs.push(`<option value="${y}">${y}</option>`);
    }
    
    // Áî¢ÁîüÊúà‰ªΩÈÅ∏È†Ö
    for (let m = 1; m <= 12; m++) {
        const mm = String(m).padStart(2,"0");
        mos.push(`<option value="${mm}">${m}</option>`);
    }
    
    // üîß ÂÆâÂÖ®ÂèñÂæóÂÖÉÁ¥†Ôºà‰øÆÂæ©ÈáçÈªûÔºâ
    const startY = document.getElementById("startYear");
    const startM = document.getElementById("startMonth");
    const endY = document.getElementById("endYear");
    const endM = document.getElementById("endMonth");
    const stillChk = document.getElementById("stillWorking"); // ‚úÖ Âú®‰ΩøÁî®ÂâçÊâçÂÆ£Âëä
    const endDateContainer = document.getElementById("endDateContainer");
    
    // Â°´ÂÖ•Âπ¥‰ªΩÈÅ∏È†Ö
    if (startY) startY.innerHTML = yrs.join("");
    if (endY) endY.innerHTML = yrs.join("");
    
    // Â°´ÂÖ•Êúà‰ªΩÈÅ∏È†Ö
    if (startM) startM.innerHTML = mos.join("");
    if (endM) endM.innerHTML = mos.join("");
    
    // üîß ÂÆâÂÖ®ËôïÁêÜ„ÄåÁõÆÂâçÂú®ËÅ∑„ÄçË§áÈÅ∏Ê°Ü‰∫ã‰ª∂
    if (stillChk && endDateContainer && endY && endM) {
        // ÁßªÈô§ËàäÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®ÔºàÈÅøÂÖçÈáçË§áÁ∂ÅÂÆöÔºâ
        stillChk.removeEventListener("change", handleStillWorkingChange);
        
        // ÂÆöÁæ©‰∫ã‰ª∂ËôïÁêÜÂáΩÊï∏
        function handleStillWorkingChange() {
            const isWorking = stillChk.checked;
            endDateContainer.classList.toggle("hidden", isWorking);
            
            // Ë®≠ÂÆö disabled ÁãÄÊÖã
            if (endY) endY.disabled = isWorking;
            if (endM) endM.disabled = isWorking;
            
            // Â¶ÇÊûúÈÅ∏‰∏≠„ÄåÁõÆÂâçÂú®ËÅ∑„ÄçÔºåÊ∏ÖÁ©∫ÁµêÊùüÊó•Êúü
            if (isWorking) {
                if (endY) endY.value = "";
                if (endM) endM.value = "";
            }
        }
        
        // Á∂ÅÂÆöÊñ∞ÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®
        stillChk.addEventListener("change", handleStillWorkingChange);
        
        console.log("‚úÖ Âπ¥Êúà‰∏ãÊãâÈÅ∏ÂñÆÂíåÁõÆÂâçÂú®ËÅ∑ÂäüËÉΩÂàùÂßãÂåñÂÆåÊàê");
    } else {
        console.warn("‚ö†Ô∏è ÈÉ®ÂàÜ DOM ÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåË∑≥ÈÅéÁõÆÂâçÂú®ËÅ∑ÂäüËÉΩË®≠ÂÆö");
        if (!stillChk) console.warn("   - stillWorking checkbox Êú™ÊâæÂà∞");
        if (!endDateContainer) console.warn("   - endDateContainer Êú™ÊâæÂà∞");
        if (!endY) console.warn("   - endYear select Êú™ÊâæÂà∞");
        if (!endM) console.warn("   - endMonth select Êú™ÊâæÂà∞");
    }
}

// ÂáΩÂºè‰∏ÄÔºöÁÇ∫Êñ∞Áî®Êà∂ÂºïÂ∞éÂΩàÁ™óÁöÑÂπ¥Êúà‰∏ãÊãâÈÅ∏ÂñÆÂ°´ÂÖ•ÈÅ∏È†Ö
function populateOnboardingYearMonth() {
    const now = new Date(), thisYear = now.getFullYear();
    let yrs = ['<option value="">--</option>'], mos = ['<option value="">--</option>'];
    for (let y = thisYear; y >= thisYear - 40; y--) {
        yrs.push(`<option>${y}</option>`);
    }
    for (let m = 1; m <= 12; m++) {
        const mm = String(m).padStart(2,"0");
        mos.push(`<option value="${mm}">${m}</option>`);
    }

    const startY = document.getElementById("onboarding-startYear");
    const startM = document.getElementById("onboarding-startMonth");
    const endY = document.getElementById("onboarding-endYear");
    const endM = document.getElementById("onboarding-endMonth");
    const stillChk = document.getElementById("onboarding-stillWorking");
    const endDateContainer = document.getElementById("onboarding-endDateContainer");
    
    if (startY) startY.innerHTML = yrs.join("");
    if (endY) endY.innerHTML = yrs.join("");
    if (startM) startM.innerHTML = mos.join("");
    if (endM) endM.innerHTML = mos.join("");
    
    if (stillChk && endDateContainer) {
        stillChk.addEventListener("change", () => {
            endDateContainer.classList.toggle("hidden", stillChk.checked);
        });
    }
}

// ========================================
// 4Ô∏è‚É£ Ê•≠ÂãôÈÇèËºØÂáΩÂºè
// ========================================

// ‚ú® ÂÑ≤Â≠ò‰ΩøÁî®ËÄÖÂÄã‰∫∫Ë≥áÊñô
async function saveProfile() {
    console.group("üîç saveProfile()");
    console.log("‚Üí profile.userId =", window.profile.userId);
    console.log("‚Üí profile payload =", window.profile);
    if (!window.profile.userId) {
        console.warn("‚ùå saveProfile() ‰∏≠Êñ≠Ôºöprofile.userId ‰∏∫Á©∫");
        console.groupEnd();
        return;
    }

    try {
        const ref = db.collection("users").doc(window.profile.userId);

        const existingSnap = await ref.get();
        // üîß ‰øÆÂæ©ÔºöÂÖºÂÆπÊñ∞ËàäÁâàÊú¨ÁöÑ exists Ê™¢Êü•
        const snapExists = typeof existingSnap.exists === 'function' ? existingSnap.exists() : existingSnap.exists;
        
        if (snapExists) {
            const existingData = existingSnap.data();
            if (!window.profile.name && existingData.name) {
                window.profile.name = existingData.name;
            }
            if (!window.profile.englishName && existingData.englishName) {
                window.profile.englishName = existingData.englishName;
            }
        }

        await ref.set(window.profile, { merge: true });
        console.log("‚úÖ saveProfile() ÂÜôÂÖ•ÊàêÂäü");
    } catch (err) {
        console.error("‚ùå saveProfile() ÂÜôÂÖ•Â§±Ë¥•Ôºö", err);
    }

    console.groupEnd();
}

// ‚ú® ËºâÂÖ•‰ΩøÁî®ËÄÖÊé®Ëñ¶Ë≥áÊñô
async function loadUserRecommendations(userId) {
    console.log("üì• ËºâÂÖ•Áî®Êà∂Êé®Ëñ¶Êï∏Êìö...");
    
    try {
        const recommendations = [];
        
        const receivedRef = db.collection("users").doc(userId).collection("recommendations");
        const receivedSnapshot = await receivedRef.get();
        
        receivedSnapshot.forEach(doc => {
            recommendations.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        for (const job of window.profile.workExperiences) {
            if (job.recommendations && Array.isArray(job.recommendations)) {
                job.recommendations.forEach(rec => {
                    recommendations.push({
                        ...rec,
                        type: 'outgoing',
                        jobId: job.id
                    });
                });
            }
        }
        
        console.log(`‚úÖ ËºâÂÖ•Êé®Ëñ¶Ë®òÈåÑÁ∏ΩË®à: ${recommendations.length} Á≠Ü`);
        
        // Ë®àÁÆóÁµ±Ë®à
        const newStats = calculateRecommendationStats(recommendations);
        
        // üëá --- ÈÄôÊòØÊúÄÊ†∏ÂøÉÁöÑ‰øÆÊ≠£ --- üëá
        // ‰ΩøÁî® Object.assign Â∞áÊñ∞Ë®àÁÆóÂá∫ÁöÑÁµ±Ë®àÊï∏ÊìöÂêà‰ΩµÂà∞ÁèæÊúâÁöÑ recommendationStats ‰∏≠Ôºå
        // ÈÄôÊ®£Êó¢ËÉΩÊõ¥Êñ∞ totalReceived Á≠âÊï∏ÊìöÔºåÂèàËÉΩ‰øùÁïôÂæûË≥áÊñôÂ∫´ËÆÄ‰æÜÁöÑ exp„ÄÇ
        window.profile.recommendationStats = Object.assign(window.profile.recommendationStats || {}, newStats);
        // üëÜ --- Ê†∏ÂøÉ‰øÆÊ≠£ÁµêÊùü --- üëÜ

        window.profile.recommendations = recommendations;

        // Â∞áÁµ±Ë®àÊï∏ÊìöÊò†Â∞ÑÂà∞Â∑•‰ΩúÁ∂ìÊ≠∑
        window.profile.workExperiences.forEach(job => {
            const jobStats = window.profile.recommendationStats.byJob[job.id] || {
                received: 0, given: 0, canReply: 0, allReceived: 0,
                verified: 0, pending: 0, failed: 0, highlights: {}, relations: {}
            };

            const originalGivenCount = job.givenCount;

            job.recCount = jobStats.received;
            job.canReplyCount = jobStats.canReply;
            job.allReceived = jobStats.allReceived;
            job.verified = jobStats.verified;
            job.pending = jobStats.pending;
            job.failed = jobStats.failed;
            
            if (typeof originalGivenCount === 'undefined' || originalGivenCount === null) {
                job.givenCount = 0;
            }

            job.highlightCount = typeof jobStats.highlights === 'object' ? jobStats.highlights : {};
            job.relationCount = typeof jobStats.relations === 'object' ? jobStats.relations : {};
        });

        console.log("‚úÖ Êé®Ëñ¶Áµ±Ë®àÊò†Â∞ÑÂÆåÊàê");
        
        // Ëß∏Áôº UI ÈáçÊñ∞Ê∏≤Êüì
        const list = document.getElementById("experienceList");
        if (list && window.profile) {
            renderExperienceCardsWithReply(list, window.profile);
            console.log("‚úÖ renderExperienceCardsWithReply Â∑≤Ë™øÁî®");
        }
        
        return recommendations;
        
    } catch (error) {
        console.error("‚ùå ËºâÂÖ•Êé®Ëñ¶Êï∏ÊìöÂ§±Êïó:", error);
        return [];
    }
}

// ‚ú® Ë®àÁÆóÊé®Ëñ¶Áµ±Ë®à
function calculateRecommendationStats(recommendations) {
    const stats = {
        totalReceived: 0, totalGiven: 0, totalCanReply: 0, byJob: {}
    };

    if (!recommendations || recommendations.length === 0) {
        return stats;
    }

    // È†êÂÖàÂª∫Á´ãÂ∑≤Êé®Ëñ¶Â∞çË±°ÁöÑ Set
    const recommendedTargets = new Set();
    recommendations.forEach(rec => {
        if (rec.type === 'outgoing' || rec.type === 'reply') {
            if (rec.targetUserId) recommendedTargets.add(rec.targetUserId);
            if (rec.recommendeeEmail) recommendedTargets.add(rec.recommendeeEmail.toLowerCase());
            if (rec.targetEmail) recommendedTargets.add(rec.targetEmail.toLowerCase());
        }
    });

    // ÈÅçÊ≠∑ÊâÄÊúâÊé®Ëñ¶Ë®òÈåÑÈÄ≤Ë°åË®àÁÆó
    recommendations.forEach(rec => {
        const jobId = rec.matchedJobId || rec.jobId;
        if (!jobId) return;

        if (!stats.byJob[jobId]) {
            stats.byJob[jobId] = {
                received: 0, given: 0, canReply: 0, allReceived: 0,
                verified: 0, pending: 0, failed: 0, highlights: {}, relations: {}
            };
        }
        const jobStats = stats.byJob[jobId];

        // ËôïÁêÜÊî∂Âà∞ÁöÑÊé®Ëñ¶
        if (rec.type === 'received') {
            jobStats.allReceived++;

            const isVerified = rec.status === 'verified' && (rec.confidence || 0) > 0 && !rec.excludeFromStats;

            if (isVerified) {
                stats.totalReceived++;
                jobStats.received++;
                jobStats.verified++;

                (rec.highlights || []).forEach(h => {
                    jobStats.highlights[h] = (jobStats.highlights[h] || 0) + 1;
                });
                const relation = rec.relation || "unknown";
                jobStats.relations[relation] = (jobStats.relations[relation] || 0) + 1;
            } else {
                if (rec.status === 'verification_failed') {
                    jobStats.failed++;
                } else {
                    jobStats.pending++;
                }
            }

            // Âà§Êñ∑ÊòØÂê¶ÂèØÂõûË¶Ü
            if (rec.status === 'verified' && !rec.hasReplied) {
                const alreadyRecommended = recommendedTargets.has(rec.recommenderId) || 
                                         recommendedTargets.has((rec.email || '').toLowerCase());
                
                // Âè™ÊúâÂú®Â∞öÊú™ÂõûË¶ÜÔºå‰∏î‰πüÂ∞öÊú™‰∏ªÂãïÊé®Ëñ¶ÈÅéÂ∞çÊñπÁöÑÊÉÖÊ≥Å‰∏ãÔºåÊâçÁÆóÂèØÂõûË¶Ü
                if (!alreadyRecommended) {
                    stats.totalCanReply++;
                    jobStats.canReply++;
                }
            }
        }

        // ËôïÁêÜÈÄÅÂá∫ÁöÑÊé®Ëñ¶
        if (rec.type === 'outgoing' || rec.type === 'reply') {
            const isValidGiven = ['verified', 'delivered_and_verified', 'confirmed'].includes(rec.status);
            
            if (isValidGiven) {
                stats.totalGiven++;
                jobStats.given++;
            }
        }
    });

    return stats;
}

// ‚ú® Êé®Ëñ¶‰ªñ‰∫∫ÂäüËÉΩ
async function handleRecommendOthers(jobIndex) {
    const job = window.profile.workExperiences[jobIndex];
    
    try {
        if (!auth.currentUser) {
            showToast(t('common.loginRequired'));
            return;
        }

        console.log("üîç ÂòóË©¶Âª∫Á´ãÊé®Ëñ¶‰ªñ‰∫∫ÈÇÄË´ã...");
        
        const lang = localStorage.getItem("lang") || "zh-Hant";
        
        const inviteRef = await db.collection("invites").add({
            userId: window.profile.userId,
            jobId: job.id,
            type: "outgoing",
            company: job.company,
            position: job.position,
            recommenderName: window.profile.name,
            recommenderUserId: window.profile.userId,
            recommenderEmail: window.profile.email,
            recommenderJobId: job.id,
            lang: lang,
            createdAt: new Date(),
            status: "pending"
        });
        
        const inviteId = inviteRef.id;
        const targetUrl = `/pages/recommend-form.html?inviteId=${inviteId}&mode=outgoing`;
        
        showToast(t('profileDashboard.openingRecommendForm'));
        smartOpenRecommendation(targetUrl, t('profileDashboard.recommendFormTitle'));
        
    } catch (err) {
        console.error("‚ùå Âª∫Á´ãÊé®Ëñ¶‰ªñ‰∫∫ÈÇÄË´ãÂ§±ÊïóÔºö", err);
        
        let errorMessage = t('profileDashboard.createInviteError');
        if (err.code === 'permission-denied') {
            errorMessage = t('profileDashboard.permissionDenied');
        } else if (err.code === 'unavailable') {
            errorMessage = t('profileDashboard.networkError');
        }
        
        showToast(errorMessage);
    }
}

// ‚ú® ÂõûË¶ÜÊé®Ëñ¶ÂäüËÉΩ
async function handleReplyRecommendation(jobIndex) {
    const job = window.profile.workExperiences[jobIndex];
    
    try {
        console.log("üí¨ ËºâÂÖ•ÂõûË¶ÜÈÅ∏È†Ö...");
        
        const availableRecommendations = window.profile.recommendations.filter(rec => {
            const matchesJob = (rec.matchedJobId || rec.jobId) === job.id;
            const isReceived = rec.type === 'received';
            const notReplied = !rec.hasReplied;
            const isVerified = rec.status === 'verified'; // <--- Ê†πÊìöÊñá‰ª∂Êñ∞Â¢ûÁöÑÊ™¢Êü•
            const canReply = rec.canReply === true;       // <--- Ê†πÊìöÊñá‰ª∂Êñ∞Â¢ûÁöÑÊ™¢Êü•
            
            return matchesJob && isReceived && isVerified && notReplied && canReply;
        });
        
        if (availableRecommendations.length === 0) {
            showToast(t('profileDashboard.noReplyAvailable'));
            return;
        }
        
        // ‰øùÂ≠òÁï∂Ââç‰∏ä‰∏ãÊñá
        window.currentReplyContext = {
            jobIndex: jobIndex,
            job: job,
            availableRecommendations: availableRecommendations
        };
        
        // È°ØÁ§∫ÂõûË¶ÜÈÅ∏È†Ö Modal
        document.getElementById("replyOptionsModal").showModal();
        
    } catch (error) {
        console.error("‚ùå ËºâÂÖ•ÂõûË¶ÜÈÅ∏È†ÖÂ§±Êïó:", error);
        showToast(t('profileDashboard.loadReplyOptionsError'));
    }
}

// ‚ú® ÈñãÂßãÂõûÊé®Ëñ¶ÊµÅÁ®ã
async function startReplyProcess(originalRecId, recommenderId, recommenderName, recommenderEmail, isRegistered) {
    console.log("üöÄ startReplyProcess ÂèÉÊï∏Ê™¢Êü•:", {
        originalRecId, recommenderId, recommenderName, recommenderEmail, isRegistered
    });
    
    if (isRegistered && (!recommenderId || recommenderId === '' || recommenderId === 'null')) {
        console.error("‚ùå Â∑≤Ë®ªÂÜäÁî®Êà∂‰ΩÜ recommenderId ÁÑ°Êïà:", recommenderId);
        showToast(t('profileDashboard.recommenderDataError'));
        return;
    }
    
    try {
        const originalRec = window.profile.recommendations.find(rec => rec.id === originalRecId);
        if (!originalRec) {
            showToast(t('profileDashboard.originalRecommendationNotFound'));
            return;
        }
        
        const lang = localStorage.getItem("lang") || "zh-Hant";
        
        const inviteData = {
            userId: window.profile.userId,
            jobId: originalRec.jobId,
            type: "reply",
            mode: "reply",
            originalRecommendationId: originalRecId,
            targetName: recommenderName,
            targetEmail: recommenderEmail,
            recommenderName: window.profile.name,
            recommenderUserId: window.profile.userId,
            company: window.currentReplyContext?.job?.company || '',
            position: window.currentReplyContext?.job?.position || '',
            lang: lang,
            createdAt: new Date(),
            status: "pending"
        };
        
        if (isRegistered && recommenderId) {
            inviteData.targetUserId = recommenderId;
        }
        
        const replyInviteRef = await db.collection("invites").add(inviteData);
        const inviteId = replyInviteRef.id;

        let targetUrl = `/pages/recommend-form.html` +
            `?inviteId=${inviteId}` +
            `&mode=reply` +
            `&originalRecId=${originalRecId}` +
            `&prefillName=${encodeURIComponent(recommenderName)}` +
            `&prefillEmail=${encodeURIComponent(recommenderEmail)}` +
            `&jobId=${encodeURIComponent(window.currentReplyContext?.job?.id || '')}` +
            `&lang=${lang}`;
        
        if (isRegistered && recommenderId) {
            targetUrl += `&targetUserId=${recommenderId}`;
        } else {
            targetUrl += `&unregistered=true`;
        }
        
        // ÈóúÈñâÈÅ∏Êìá Modal
        document.getElementById("replyModal").close();
        
        const message = isRegistered ? t('profileDashboard.openingReplyForm') : t('profileDashboard.openingUnregisteredReplyForm');
        showToast(message);
        smartOpenRecommendation(targetUrl, t('profileDashboard.replyFormTitle'));
        
    } catch (error) {
        console.error("‚ùå Âª∫Á´ãÂõûÊé®Ëñ¶ÈÇÄË´ãÂ§±Êïó:", error);
        showToast(t('profileDashboard.createInviteError'));
    }
}

// ========================================
// 5Ô∏è‚É£ ‰∫ã‰ª∂ËôïÁêÜÂáΩÂºè
// ========================================

// ‚ú® ÂÄã‰∫∫Ê™îÊ°àÁ∑®ËºØ‰∫ã‰ª∂
function bindProfileEditEvents(userRef, profile) {
    const profileEditModal = document.getElementById('profileEditModal');
    const profileEditForm = document.getElementById('profileEditForm');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const saveChangesBtn = document.getElementById('save-changes-btn');

    function bindOpenModalButton() {
        const btn = document.getElementById('open-edit-modal-btn');
        if (btn) {
            btn.onclick = () => {
                // Â°´ÂÖ•ÁèæÊúâË≥áÊñô
                document.getElementById('edit-english-name').value = profile.englishName || '';
                document.getElementById('edit-headline').value = profile.headline || '';
                document.getElementById('edit-bio').value = profile.bio || '';
                
                // üÜï Âº∑Âà∂Âà∑Êñ∞ Modal ÁøªË≠Ø
                forceRefreshModalTranslations('profileEditModal');
                
                profileEditModal.showModal();
            };
        }
    }

    bindOpenModalButton();

    // ÂèñÊ∂àÊåâÈàï‰∫ã‰ª∂
    if (cancelEditBtn) {
        cancelEditBtn.onclick = () => profileEditModal.close();
    }

    // Ë°®ÂñÆÊèê‰∫§‰∫ã‰ª∂Ôºà‰øùÊåÅÂéüÊúâÈÇèËºØÔºâ
    if (profileEditForm) {
        profileEditForm.onsubmit = async (e) => {
            e.preventDefault();
            saveChangesBtn.disabled = true;
            
            const savingText = window.t ? window.t('profileDashboard.saving') : 'Saving...';
            saveChangesBtn.textContent = savingText;

            const dataToUpdate = {
                englishName: document.getElementById('edit-english-name').value.trim(),
                headline: document.getElementById('edit-headline').value.trim(),
                bio: document.getElementById('edit-bio').value.trim(),
            };

            try {
                await userRef.update(dataToUpdate);
                Object.assign(profile, dataToUpdate);

                renderBasicInfo(profile);
                renderBioSection(profile);
                bindOpenModalButton();

                const successMsg = window.t ? window.t('profileDashboard.updateSuccess') : '‚úÖ Update successful!';
                showToast(successMsg);
                profileEditModal.close();

            } catch (error) {
                console.error("Êõ¥Êñ∞Ê™îÊ°àÂ§±Êïó:", error);
                const errorMsg = window.t ? 
                    `${window.t('profileDashboard.updateFailed')} ${error.message}` : 
                    `‚ùå Update failed: ${error.message}`;
                showToast(errorMsg);
            } finally {
                saveChangesBtn.disabled = false;
                const saveText = window.t ? window.t('profileDashboard.saveChanges') : 'Save Changes';
                saveChangesBtn.textContent = saveText;
            }
        };
    }
}

// ‚ú® ÂõûÊé®Ëñ¶Modal‰∫ã‰ª∂
function bindReplyModalEvents() {
    const replyCloseBtn = document.getElementById("replyCloseBtn");
    if (replyCloseBtn) {
        replyCloseBtn.onclick = () => {
            document.getElementById("replyModal").close();
        };
    }
    
    const replyList = document.getElementById("replyList");
    if (replyList) {
        replyList.addEventListener("click", (e) => {
            if (e.target.closest(".reply-to-person-btn")) {
                const btn = e.target.closest(".reply-to-person-btn");
                const recId = btn.dataset.recId;
                const recommenderId = btn.dataset.recommenderId;
                const recommenderName = btn.dataset.recommenderName;
                const recommenderEmail = btn.dataset.recommenderEmail;
                const isRegistered = btn.dataset.isRegistered === 'true';
                
                startReplyProcess(recId, recommenderId, recommenderName, recommenderEmail, isRegistered);
            }
        });
    }
}

// ÂáΩÂºè‰∫åÔºöËôïÁêÜÊñ∞Áî®Êà∂ÂºïÂ∞éÂΩàÁ™óÁöÑÊèê‰∫§‰∫ã‰ª∂
async function handleOnboardingSubmit(e) {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled = true;

    // 1. Êî∂ÈõÜÂßìÂêçË≥áÊñô
    window.profile.name = document.getElementById('onboarding-name').value.trim();
    window.profile.englishName = document.getElementById('onboarding-english-name').value.trim();

    // 2. Êî∂ÈõÜÂ∑•‰ΩúÁ∂ìÊ≠∑Ë≥áÊñô
    const company = document.getElementById('onboarding-company').value.trim();
    const position = document.getElementById('onboarding-position').value.trim();
    const startYear = document.getElementById('onboarding-startYear').value;
    const startMonth = document.getElementById('onboarding-startMonth').value;
    const isStillWorking = document.getElementById('onboarding-stillWorking').checked;
    const endYear = isStillWorking ? "" : document.getElementById('onboarding-endYear').value;
    const endMonth = isStillWorking ? "" : document.getElementById('onboarding-endMonth').value;

    if (!window.profile.name || !company || !position || !startYear || !startMonth) {
        alert("Ë´ãÂ°´ÂØ´ÊâÄÊúâÂøÖÂ°´Ê¨Ñ‰ΩçÔºÅ");
        btn.disabled = false;
        return;
    }

    const jobData = {
        id: Date.now().toString(),
        company,
        position,
        startDate: `${startYear}-${startMonth}`,
        endDate: (endYear && endMonth) ? `${endYear}-${endMonth}` : "",
        description: "", // È¶ñÊ¨°ÂºïÂ∞éÂèØÁïôÁ©∫
    };

    window.profile.workExperiences.push(jobData);

    // 3. ÂÑ≤Â≠òÂà∞ Firestore
    await saveProfile();
    
    // 4. Êõ¥Êñ∞ÂÑÄË°®ÊùøÁï´Èù¢‰∏¶ÈóúÈñâÂΩàÁ™ó
    renderBasicInfo(window.profile);
    const experienceListContainer = document.getElementById("experienceList");
    if (experienceListContainer) {
        renderExperienceCardsWithReply(experienceListContainer, window.profile);
    }
    document.getElementById('onboardingModal').close();
    showToast("Ê≠°ËøéÔºÅÊÇ®ÁöÑÂü∫Êú¨Ë≥áÊñôÂ∑≤ÂÑ≤Â≠ò„ÄÇ");
    btn.disabled = false;
}

// ‚ú® ÂõûË¶ÜÈÅ∏È†ÖModal‰∫ã‰ª∂
function initializeReplyOptionsModal() {
    const replyOptionsCloseBtn = document.getElementById("replyOptionsCloseBtn");
    if (replyOptionsCloseBtn) {
        replyOptionsCloseBtn.onclick = () => {
            document.getElementById("replyOptionsModal").close();
        };
    }
    
    const replyOptionsModal = document.getElementById("replyOptionsModal");
    if (replyOptionsModal) {
        replyOptionsModal.addEventListener("click", (e) => {
            // Êé®Ëñ¶ÂõûË¶ÜÈÅ∏È†Ö
            if (e.target.closest('[data-option="recommend"]')) {
                console.log("üìù Áî®Êà∂ÈÅ∏ÊìáÊé®Ëñ¶ÂõûË¶Ü");
                trackEvent('reply_option_selected', { type: 'recommend' });
                document.getElementById("replyOptionsModal").close();
                showTraditionalReplyModal();
            }
            // ÂíñÂï°ÊÑüË¨ùÈÅ∏È†Ö
            else if (e.target.closest('[data-option="coffee"]')) {
                console.log("‚òï Áî®Êà∂ÈªûÊìäÂíñÂï°ÊÑüË¨ùÈÅ∏È†Ö");
                trackEvent('coffee_option_clicked', { 
                    jobId: window.currentReplyContext?.job?.id,
                    availableCount: window.currentReplyContext?.availableRecommendations?.length
                });
                document.getElementById("replyOptionsModal").close();
                document.getElementById("waitlistModal").showModal();
            }
        });
    }
}

// ‚ú® ÂÇ≥Áµ±ÂõûÊé®Ëñ¶Modal
function showTraditionalReplyModal() {
    const context = window.currentReplyContext;
    if (!context) return;
    
    const replyList = document.getElementById("replyList");
    replyList.innerHTML = "";
    
    const canReplyRecommendations = context.availableRecommendations.filter(rec => {
        const currentJobId = context.job.id;
        
        if (!window.profile.recommendations || !Array.isArray(window.profile.recommendations)) {
            return true;
        }
        
        // Ê™¢Êü•ÊòØÂê¶Â∑≤Âú®Áï∂ÂâçÂ∑•‰ΩúÊé®Ëñ¶ÈÅéÊ≠§‰∫∫
        const alreadyRepliedInCurrentJob = window.profile.recommendations.some(myRec => 
            myRec.type === 'reply' &&
            (myRec.jobId === currentJobId || myRec.matchedJobId === currentJobId) &&
            (
                (rec.recommenderId && myRec.targetUserId === rec.recommenderId) ||
                (rec.email && myRec.targetEmail === rec.email.toLowerCase())
            )
        );
        
        const alreadyRecommendedInCurrentJob = window.profile.recommendations.some(myRec => 
            myRec.type === 'outgoing' &&
            (myRec.jobId === currentJobId || myRec.matchedJobId === currentJobId) &&
            (
                (rec.recommenderId && myRec.targetUserId === rec.recommenderId) ||
                (rec.email && myRec.recommendeeEmail === rec.email.toLowerCase())
            )
        );
        
        const alreadyInCurrentJobRecords = context.job.recommendations?.some(workRec => 
            (rec.recommenderId && workRec.targetUserId === rec.recommenderId) ||
            (rec.email && workRec.recommendeeEmail === rec.email.toLowerCase())
        ) || false;
        
        const alreadyProcessedInCurrentJob = alreadyRepliedInCurrentJob || 
                                            alreadyRecommendedInCurrentJob || 
                                            alreadyInCurrentJobRecords;
        
        return !alreadyProcessedInCurrentJob;
    });
    
    canReplyRecommendations.forEach(rec => {
        const listItem = document.createElement("div");
        listItem.className = "reply-item";
        
        const recommenderId = rec.recommenderId;
        const isRegistered = recommenderId !== null && recommenderId !== undefined && recommenderId !== '';
        
        const verificationBadge = getVerificationBadge(rec);
        const relationLabel = t(`relations.${rec.relation}`, rec.relation || "Âêå‰∫ã");
        const registrationBadge = isRegistered 
            ? `<span class="registered-badge">${t('profileDashboard.registeredBadgeText')}</span>`
            : `<span class="unregistered-badge">${t('profileDashboard.unregisteredBadgeText')}</span>`;
        
        const buttonHtml = `
            <button class="action-btn primary reply-to-person-btn" 
                    data-rec-id="${rec.id}" 
                    data-recommender-id="${recommenderId || ''}"
                    data-recommender-name="${rec.name}"
                    data-recommender-email="${rec.email || ''}"
                    data-is-registered="${isRegistered}">
                üìù ${t('profileDashboard.startReply')}
            </button>
        `;
        
        listItem.innerHTML = `
            <div class="reply-item-info">
                <div class="recommender-name">
                    ${rec.name}
                    ${verificationBadge}
                    ${registrationBadge}
                </div>
                <div class="recommender-details">
                    <span class="relation-tag">${relationLabel}</span>
                    <span class="email-tag">${rec.email}</span>
                </div>
                <div class="recommendation-preview">
                    "${(rec.content || '').substring(0, 100)}${rec.content && rec.content.length > 100 ? '...' : ''}"
                </div>
            </div>
            <div class="reply-item-actions">
                ${buttonHtml}
            </div>
        `;
        
        replyList.appendChild(listItem);
    });
    
    if (canReplyRecommendations.length === 0) {
        replyList.innerHTML = `
            <div class="no-reply-available">
                <p>${t('profileDashboard.noReplyAvailable')}</p>
                <p>${t('profileDashboard.allReplied')}</p>
            </div>
        `;
    }
    
    document.getElementById("replyModal").showModal();
}

// ‚ú® Á≠âÂÄôÊ∏ÖÂñÆModal
function initializeWaitlistModal() {
    const waitlistCloseBtn = document.getElementById("waitlistCloseBtn");
    if (waitlistCloseBtn) {
        waitlistCloseBtn.onclick = () => {
            document.getElementById("waitlistModal").close();
        };
    }
    
    const waitlistForm = document.getElementById("waitlistForm");
    if (waitlistForm) {
        waitlistForm.onsubmit = async (e) => {
            e.preventDefault();
            
            const email = document.getElementById("waitlistEmail").value;
            const preference = document.getElementById("coffeePreference").value;
            
            try {
                await db.collection("coffeeWaitlist").add({
                    email: email,
                    preference: preference,
                    createdAt: new Date(),
                    source: "reply_modal",
                    userId: window.profile.userId,
                    jobContext: window.currentReplyContext?.job?.company
                });
                
                trackEvent('waitlist_signup', { 
                    preference: preference,
                    source: 'reply_modal'
                });
                
                showToast(t('profileDashboard.waitlistSignupSuccess'));
                document.getElementById("waitlistModal").close();
                waitlistForm.reset();
                
            } catch (error) {
                console.error("‚ùå Âä†ÂÖ•Á≠âÂÄôÊ∏ÖÂñÆÂ§±Êïó:", error);
                showToast(t('profileDashboard.waitlistSignupError'));
            }
        };
    }
}

// ‚ú® Êñ∞Â¢ûÂ∑•‰ΩúÁ∂ìÊ≠∑Modal
function openModalForAdd() {
    const modalTitle = document.getElementById("modalTitle");
    const expForm = document.getElementById("expForm");
    const expModal = document.getElementById("expModal");
    document.getElementById("editLockHint").classList.add("hidden");
    if (modalTitle) modalTitle.textContent = t('profileDashboard.addExperienceTitle');
    if (expForm) expForm.reset();
    editIdx = -1;
    lockCoreFields(false);
    
    // üÜï Âº∑Âà∂Âà∑Êñ∞ÁøªË≠Ø
    setTimeout(() => {
        forceRefreshModalTranslations('expModal');
    }, 0);
    
    if (expModal) expModal.showModal();
}

// ‚ú® Á∑®ËºØÂ∑•‰ΩúÁ∂ìÊ≠∑Modal
function openModalForEdit(idx) {
    const job = window.profile.workExperiences[idx];
    const modalTitle = document.getElementById("modalTitle");
    const expModal = document.getElementById("expModal");
    
    if (modalTitle) modalTitle.textContent = t('profileDashboard.editExperienceTitle');
    
    // --- Â°´ÂÖ•ÁèæÊúâË≥áÊñô (Ê≠§ÈÉ®ÂàÜÈÇèËºØ‰∏çËÆä) ---
    const companyInp = document.getElementById("companyInput");
    const positionInp = document.getElementById("positionInput");
    const startY = document.getElementById("startYear");
    const startM = document.getElementById("startMonth");
    const endY = document.getElementById("endYear");
    const endM = document.getElementById("endMonth");
    const stillChk = document.getElementById("stillWorking");
    const descInp = document.getElementById("descInput");
    
    if (companyInp) companyInp.value = job.company || "";
    if (positionInp) positionInp.value = job.position || "";
    if (descInp) descInp.value = job.description || "";
    
    if (job.startDate) {
        const [startYear, startMonth] = job.startDate.split("-");
        if (startY) startY.value = startYear;
        if (startM) startM.value = startMonth;
    }
    
    if (job.endDate) {
        const [endYear, endMonth] = job.endDate.split("-");
        if (endY) endY.value = endYear;
        if (endM) endM.value = endMonth;
        if (stillChk) stillChk.checked = false;
    } else {
        if (stillChk) stillChk.checked = true;
        if (endY) endY.value = "";
        if (endM) endM.value = "";
    }
    
    // ‚ú® --- Ê†∏ÂøÉ‰øÆÊîπ --- ‚ú®
    // 1. Ê™¢Êü•ÈÄô‰ªΩÂ∑•‰ΩúÊòØÂê¶ÊúâÂ∑≤È©óË≠âÁöÑÊé®Ëñ¶ (job.verified > 0)„ÄÇ
    //    `job.verified` ÁöÑÂÄºÊòØÂú® `loadUserRecommendations` ÂáΩÂºè‰∏≠Ë®àÁÆó‰∏¶Ë≥¶‰∫àÁöÑ„ÄÇ
    const shouldLock = job.verified && job.verified > 0;
    const lockHint = document.getElementById("editLockHint");
    if (lockHint) {
        lockHint.classList.toggle("hidden", !shouldLock);
    }
    editIdx = idx;
    
    // 2. Â∞áÊ™¢Êü•ÁµêÊûú (true/false) ÂÇ≥ÈÅûÁµ¶ lockCoreFields ÂáΩÂºè„ÄÇ
    lockCoreFields(shouldLock);
    setTimeout(() => {
        forceRefreshModalTranslations('expModal');
    }, 0);
    if (expModal) expModal.showModal();
}

// ‚ú® ÈéñÂÆöÊ†∏ÂøÉÊ¨Ñ‰Ωç
function lockCoreFields(shouldLock) {
    const companyInp = document.getElementById("companyInput");
    const positionInp = document.getElementById("positionInput"); // ËÅ∑‰ΩçËº∏ÂÖ•Ê¨Ñ
    const startY = document.getElementById("startYear");
    const startM = document.getElementById("startMonth");
    
    // ‚ú® --- Ê†∏ÂøÉ‰øÆÊîπ --- ‚ú®
    // ÁèæÂú®ÔºåÂÖ¨Âè∏„ÄÅËÅ∑‰Ωç„ÄÅÈñãÂßãÊó•ÊúüÈÉΩÊúÉÊ†πÊìö shouldLock ÁöÑÂÄº (true/false) ‰æÜÊ±∫ÂÆöÊòØÂê¶Á¶ÅÁî®„ÄÇ
    if (companyInp) companyInp.disabled = shouldLock;
    if (positionInp) positionInp.disabled = shouldLock; // <--- Â∑≤Â∞áÊ≠§Ê¨Ñ‰ΩçÂä†ÂÖ•ÈéñÂÆö logique
    if (startY) startY.disabled = shouldLock;
    if (startM) startM.disabled = shouldLock;
}

// ‚ú® Ëß£ÈéñÊâÄÊúâÊ¨Ñ‰Ωç
function unlockAllFields() {
    const companyInp = document.getElementById("companyInput");
    const positionInp = document.getElementById("positionInput");
    const startY = document.getElementById("startYear");
    const startM = document.getElementById("startMonth");
    const endY = document.getElementById("endYear");
    const endM = document.getElementById("endMonth");
    
    if (companyInp) companyInp.disabled = false;
    if (positionInp) positionInp.disabled = false;
    if (startY) startY.disabled = false;
    if (startM) startM.disabled = false;
    if (endY) endY.disabled = false;
    if (endM) endM.disabled = false;
}

// ========================================
// 6Ô∏è‚É£ ËºîÂä©Â∑•ÂÖ∑ÂáΩÂºè
// ========================================

// ‚ú® È©óË≠âÁãÄÊÖãÂæΩÁ´†
function getVerificationBadge(rec) {
    if (rec.status === 'verified' && (rec.confidence || 0) > 0) {
        return `<span class="verified-badge">${t('profileDashboard.verifiedBadgeText')}</span>`;
    } else {
        return '';
    }
}

// ‚ú® ‰∫ã‰ª∂ËøΩËπ§
function trackEvent(eventName, properties = {}) {
    console.log("üìä ËøΩËπ§‰∫ã‰ª∂:", eventName, properties);
    
    const events = JSON.parse(localStorage.getItem("replyAnalytics") || "[]");
    events.push({
        event: eventName,
        properties: properties,
        timestamp: new Date().toISOString(),
        userId: window.profile.userId
    });
    
    if (events.length > 100) {
        events.splice(0, events.length - 100);
    }
    
    localStorage.setItem("replyAnalytics", JSON.stringify(events));
}

// ‚ú® Ë™øË©¶ÂáΩÊï∏
function debugRecommendationData() {
    console.log("üîç === Êé®Ëñ¶Êï∏ÊìöË™øË©¶ ===");
    console.log("Profile:", window.profile);
    console.log("Êé®Ëñ¶Ë®òÈåÑÁ∏ΩÊï∏:", window.profile.recommendations?.length || 0);
    console.log("Â∑•‰ΩúÁ∂ìÊ≠∑Êï∏:", window.profile.workExperiences?.length || 0);
    
    if (window.profile.recommendations) {
        console.log("üìä Êé®Ëñ¶Ë®òÈåÑË©≥ÊÉÖ:");
        window.profile.recommendations.forEach((rec, index) => {
            console.log(`${index + 1}. ${rec.name}:`, {
                id: rec.id,
                jobId: rec.jobId,
                type: rec.type,
                hasReplied: rec.hasReplied,
                recommenderId: rec.recommenderId,
                isRegistered: rec.recommenderId !== null
            });
        });
    }
}

// ‚ú® Firebase Á≠âÂæÖÂáΩÊï∏
function waitForFirebase() {
    return new Promise((resolve, reject) => {
        console.log("üîç Ê™¢Êü• Firebase ÁãÄÊÖã...");
        
        if (typeof firebase === 'undefined') {
            console.error("‚ùå Firebase SDK Êú™ËºâÂÖ•");
            reject(new Error(t('profileDashboard.firebaseSDKNotLoaded')));
            return;
        }
        
        if (window.firebaseReady) {
            try {
                app = window.firebaseApp || firebase.app();
                auth = firebase.auth();
                db = firebase.firestore();
                console.log("‚úÖ Firebase Â∑≤Ê∫ñÂÇôÂ∞±Á∑í");
                resolve();
            } catch (error) {
                console.error("‚ùå Firebase ÊúçÂãôÂàùÂßãÂåñÂ§±Êïó:", error);
                reject(error);
            }
            return;
        }
        
        if (window.firebaseError) {
            reject(window.firebaseError);
            return;
        }
        
        try {
            app = firebase.app();
            auth = firebase.auth();
            db = firebase.firestore();
            console.log("‚úÖ Áõ¥Êé•‰ΩøÁî®ÁèæÊúâ Firebase ÂØ¶‰æã");
            resolve();
            return;
        } catch (directInitError) {
            console.log("‚ö†Ô∏è ÁÑ°Ê≥ïÁõ¥Êé•‰ΩøÁî® FirebaseÔºåÁ≠âÂæÖÂàùÂßãÂåñ‰∫ã‰ª∂...");
        }
        
        const onReady = (event) => {
            try {
                app = event.detail.app || firebase.app();
                auth = firebase.auth();
                db = firebase.firestore();
                console.log("‚úÖ Firebase ÂàùÂßãÂåñÂÆåÊàê‰∫ã‰ª∂Êî∂Âà∞");
                cleanup();
                resolve();
            } catch (error) {
                console.error("‚ùå ‰∫ã‰ª∂ËôïÁêÜ‰∏≠ÁöÑÈåØË™§:", error);
                cleanup();
                reject(error);
            }
        };
        
        const onError = (event) => {
            console.error("‚ùå Firebase ÂàùÂßãÂåñÂ§±Êïó‰∫ã‰ª∂Êî∂Âà∞:", event.detail.error);
            cleanup();
            reject(event.detail.error);
        };
        
        const cleanup = () => {
            window.removeEventListener('firebaseReady', onReady);
            window.removeEventListener('firebaseError', onError);
            if (timeoutId) clearTimeout(timeoutId);
        };
        
        window.addEventListener('firebaseReady', onReady);
        window.addEventListener('firebaseError', onError);
        
        const timeoutId = setTimeout(() => {
            cleanup();
            
            try {
                app = firebase.app();
                auth = firebase.auth();
                db = firebase.firestore();
                console.log("‚úÖ Ë∂ÖÊôÇÂæåÊàêÂäüÁç≤Âèñ Firebase ÂØ¶‰æã");
                resolve();
            } catch (finalError) {
                console.error("‚ùå ÊúÄÁµÇÂòóË©¶Â§±Êïó:", finalError);
                reject(new Error(t('profileDashboard.firebaseInitTimeout')));
            }
        }, 15000);
    });
}

// ========================================
// 7Ô∏è‚É£ ‰∏ªË¶ÅÂàùÂßãÂåñÊµÅÁ®ãÔºàGemini ÂÑ™ÂåñÁâàÊú¨Ôºâ
// ========================================

document.addEventListener("DOMContentLoaded", async () => {
    console.log("üöÄ DOMContentLoaded Ëß∏Áôº");
    
    try {
        // üïí È°ØÁ§∫ËºâÂÖ•‰∏≠ÈÅÆÁΩ©
        document.getElementById("dashboardLoading").style.display = "flex";
        
        // üî• Á≠âÂæÖ Firebase ÂàùÂßãÂåñÂÆåÊàêÔºà‰ΩøÁî® Gemini Âª∫Ë≠∞ÁöÑÊñπÂºèÔºâ
        await window.firebasePromise;
        app = firebase.app();
        auth = firebase.auth();
        db = firebase.firestore();
        console.log("‚úÖ Firebase ÂàùÂßãÂåñÂÆåÊàê");

        // üåç Ë™ûË®ÄÂàáÊèõ‰∫ã‰ª∂Áõ£ËÅΩ
        window.addEventListener("langChanged", () => {
            // `setLang` Â∑≤Á∂ìËôïÁêÜ‰∫ÜÊâÄÊúâ `data-i18n` Âíå `data-i18n-placeholder`
            // ÊâÄ‰ª•ÊàëÂÄëÂè™ÈúÄË¶ÅËôïÁêÜÂãïÊÖãÂíåË§áÈõúÁöÑÂÖßÂÆπ
            updateOnboardingText();

            // üÜï Âà∑Êñ∞ Modal ÁøªË≠Ø
            setTimeout(() => {
                forceRefreshModalTranslations();
            }, 100);
            
            // ÈáçÊñ∞Ê∏≤ÊüìÂãïÊÖãÂÖßÂÆπ
            const list = document.getElementById("experienceList");
            if (list && window.profile) {
                renderExperienceCardsWithReply(list, window.profile);
            }
            
            // Êõ¥Êñ∞ placeholder
            const inviteTextarea = document.getElementById('inviteTextarea');
            if (inviteTextarea) {
                inviteTextarea.setAttribute("placeholder", t('profileDashboard.invitePlaceholder'));
            }
        });

        // üìã ÂàùÂßãÂåñ UI ÁµÑ‰ª∂
        populateYearMonth();

        // üîΩ Áï∂‰ΩøÁî®ËÄÖÁôªÂÖ•ÂæåÁöÑËôïÁêÜÊµÅÁ®ã
        auth.onAuthStateChanged(async user => {
            try {
                if (!user) {
                    console.log("‰ΩøÁî®ËÄÖÊú™ÁôªÂÖ•ÔºåÊ≠£Âú®Â∞éÂêëÁôªÂÖ•È†Å...");
                    if (!window.location.pathname.includes('login.html')) {
                        window.location.href = "/pages/login.html";
                    }
                    return;
                }
                
                console.log("‰ΩøÁî®ËÄÖÂ∑≤ÁôªÂÖ•ÔºåID:", user.uid);
                
                // üîß Ë®≠ÂÆö‰ΩøÁî®ËÄÖ ID
                window.profile.userId = user.uid;
                
                // üì• Âæû Firestore ËÆÄÂèñ‰ΩøÁî®ËÄÖË≥áÊñô
                const userRef = db.collection("users").doc(user.uid);
                const docSnap = await userRef.get();

                const docExists = typeof docSnap.exists === 'function' ? docSnap.exists() : docSnap.exists;

                if (docExists) { 
                    Object.assign(window.profile, docSnap.data());
                    console.log("ÊàêÂäüÂæû Firestore ËºâÂÖ•‰ΩøÁî®ËÄÖË≥áÊñô");
                } else {
                    console.log("Âª∫Á´ãÊñ∞ÁöÑ‰ΩøÁî®ËÄÖË≥áÊñô");
                    const newProfileData = {
                        name: user.displayName || t("profileDashboard.newUser"),
                        email: user.email,
                        createdAt: new Date(),
                        isPublicProfile: true,
                        workExperiences: [],
                        recommendationStats: { exp: 0, totalReceived: 0, totalGiven: 0 },
                        settings: { showLevelOnPublicProfile: true }
                    };
                    await userRef.set(newProfileData);
                    Object.assign(window.profile, newProfileData);
                }

                if (!Array.isArray(window.profile.workExperiences)) {
                    window.profile.workExperiences = Object.values(window.profile.workExperiences || {});
                }

                const isNewUserSetupRequired = !window.profile.name || (window.profile.workExperiences || []).length === 0;

                if (isNewUserSetupRequired) {
                    console.log("‚ÑπÔ∏è ÂÅµÊ∏¨Âà∞Êñ∞Áî®Êà∂ÊàñË≥áÊñô‰∏çÂÆåÊï¥ÁöÑÁî®Êà∂ÔºåÈñãÂïüÂºïÂ∞éÂΩàÁ™ó„ÄÇ");
                    populateOnboardingYearMonth(); 
                    forceRefreshModalTranslations('onboardingModal'); // Á¢∫‰øù modal ÁøªË≠ØÊ≠£Á¢∫
                    document.getElementById('onboardingModal').showModal();
                }

                // --- üé® Ê∏≤ÊüìÊâÄÊúâ UI ÁµÑ‰ª∂ ---
                renderBasicInfo(window.profile);
                renderBioSection(window.profile);
                
                await loadUserRecommendations(window.profile.userId);
                const stats = window.profile.recommendationStats || {};
                const totalReceived = stats.totalReceived || 0;
                const totalGiven = stats.totalGiven || 0;

                const hasAnyVerifiedRec = totalReceived > 0 || totalGiven > 0;
                const quickStartCard = document.getElementById('quickStartCard');

                if (hasAnyVerifiedRec) {
                    // Â¶ÇÊûúÊúâÂ∑≤È©óË≠âÊé®Ëñ¶ÔºåÂ∞±Èö±ËóèÂç°Áâá
                    quickStartCard.style.display = 'none';
                    quickStartCard.classList.remove('show'); // ÂêåÊôÇÁßªÈô§ show class
                } else {
                    // Â¶ÇÊûúÊ≤íÊúâÔºåÊâçÈ°ØÁ§∫Âç°Áâá
                    console.log("‚ÑπÔ∏è ‰ΩøÁî®ËÄÖÂ∞öÁÑ°Êé®Ëñ¶Á¥ÄÈåÑÔºåÊ∫ñÂÇôÈ°ØÁ§∫Êñ∞ÊâãÂºïÂ∞éÂç°„ÄÇ");
                    updateOnboardingText();
                    // ÁÇ∫‰∫ÜËÆì CSS ÂãïÁï´Êõ¥ÊµÅÊö¢ÔºåÂèØ‰ª•Á®çÂæÆÂª∂ÈÅ≤‰∏Ä‰∏ãÂÜçÂä†ÂÖ• 'show' class
                    setTimeout(() => {
                        quickStartCard.classList.add('show');
                    }, 100); // Âª∂ÈÅ≤ 100 ÊØ´Áßí
                }
                const experienceListContainer = document.getElementById("experienceList");
                if (experienceListContainer) {
                    renderExperienceCardsWithReply(experienceListContainer, window.profile);
                }

                const userExp = window.profile.recommendationStats?.exp || 0;
                renderUserLevel(userExp);
                
                bindProfileEditEvents(userRef, window.profile);
                
                const actionBtns = document.getElementById("actionBtns");
                if (actionBtns) {
                    actionBtns.innerHTML = '';
                    actionBtns.classList.add("btn-group");

                    const addBtn = document.createElement("button");
                    addBtn.id = "addBtn";
                    addBtn.type = "button";
                    addBtn.className = "btn cta-btn";
                    addBtn.setAttribute("data-i18n", "profileDashboard.addExperience");
                    addBtn.innerText = t('profileDashboard.addExperience');
                    addBtn.onclick = () => openModalForAdd();
                    actionBtns.appendChild(addBtn);

                    const summaryBtn = document.createElement("button");
                    summaryBtn.type = "button";
                    summaryBtn.className = "btn cta-btn";
                    summaryBtn.setAttribute("data-i18n", "profileDashboard.viewSummaryAll");
                    summaryBtn.innerText = t('profileDashboard.viewSummaryAll');
                    summaryBtn.addEventListener("click", () => {
                        const url = `/pages/recommend-summary.html?userId=${window.profile.userId}&jobIndex=0`;
                        smartOpenRecommendation(url, t('profileDashboard.recommendSummaryTitle'));
                    });
                    actionBtns.appendChild(summaryBtn);

                    const previewBtn = document.createElement("button");
                    previewBtn.type = "button";
                    previewBtn.className = "btn cta-btn";
                    previewBtn.setAttribute("data-i18n", "profileDashboard.viewPublicSummary");
                    previewBtn.innerText = t('profileDashboard.viewPublicSummary');
                    previewBtn.addEventListener("click", () => {
                        const url = `/pages/public-profile.html?userId=${window.profile.userId}`;
                        smartOpenRecommendation(url, t('profileDashboard.publicSummaryTitle'));
                    });
                    actionBtns.appendChild(previewBtn);
                }

                bindExperienceListEvents(t);
                bindExperienceFormEvents();
                bindModalCloseEvents();
                bindOnboardingEvents();

                const searchInput = document.getElementById('headerSearchInput');
                if (searchInput) {
                    searchInput.placeholder = window.t('header.searchPlaceholder');
                }
                
                // Áî±Êñº setLang ÂèØËÉΩÂú® profile Áâ©‰ª∂ÂÆåÂÖ®ËºâÂÖ•ÂâçÂü∑Ë°åÔºåÈÄôË£°ÂèØ‰ª•ÂÜçÊâãÂãïË™øÁî®‰∏ÄÊ¨°Á¢∫‰øùÊâÄÊúâÂÖßÂÆπÊõ¥Êñ∞
                if (window.setLang) {
                    window.setLang(localStorage.getItem("lang") || "zh-Hant");
                }
                
                document.getElementById("dashboardLoading").style.display = "none";
                console.log("‚úÖ ÂÑÄË°®ÊùøÂàùÂßãÂåñÂÆåÊàêÔºÅ");

            } catch (error) {
                console.error("‚ùå Âú® onAuthStateChanged ÊµÅÁ®ã‰∏≠ÁôºÁîüÈåØË™§:", error);
                document.getElementById("dashboardLoading").innerHTML = `
                    <div style="padding: 2rem; text-align: center;">
                        <h2>${t('profileDashboard.loadingError')}</h2>
                        <p>${t('profileDashboard.loadingErrorDesc')}</p>
                        <p style="font-size: 0.8em; color: grey;">${t('profileDashboard.errorDetails')}: ${error.message}</p>
                        <button onclick="location.reload()" style="padding: 10px 20px; border-radius: 5px; cursor: pointer;">${t('profileDashboard.refreshPage')}</button>
                    </div>
                `;
            }
        });

        bindReplyModalEvents();
        initializeReplyOptionsModal();
        initializeWaitlistModal();

    } catch (error) {
        console.error("‚ùå È†ÅÈù¢ÂàùÂßãÂåñÂ§±Êïó:", error);
        document.getElementById("dashboardLoading").innerHTML = `
            <div style="padding: 2rem; text-align: center;">
                <h2>${t('profileDashboard.systemInitError')}</h2>
                <p>${error.message}</p>
                <button onclick="location.reload()" style="padding: 10px 20px; border-radius: 5px; cursor: pointer;">${t('profileDashboard.refreshPage')}</button>
            </div>
        `;
    }
});

// ========================================
// üéØ ‰∫ã‰ª∂Á∂ÅÂÆöËºîÂä©ÂáΩÊï∏
// ========================================

// üéØ Á∂ÅÂÆöÂ∑•‰ΩúÁ∂ìÊ≠∑ÂàóË°®‰∫ã‰ª∂
function bindExperienceListEvents(t) {
    const experienceList = document.getElementById("experienceList");
    if (experienceList) {
        experienceList.addEventListener("click", (e) => {
            if (e.target.closest(".edit-btn")) {
                const idx = parseInt(e.target.closest(".edit-btn").dataset.idx);
                openModalForEdit(idx);
            }
            
            else if (e.target.closest(".del-btn")) {
                const idx = parseInt(e.target.closest(".del-btn").dataset.idx);
                if (confirm(t('profileDashboard.deleteConfirm'))) {
                    window.profile.workExperiences.splice(idx, 1);
                    saveProfile();
                    renderExperienceCardsWithReply(experienceList, window.profile);
                    showToast(t('profileDashboard.deleted'));
                }
            }
            
            else if (e.target.closest(".recommend-others-btn")) {
                const idx = parseInt(e.target.closest(".recommend-others-btn").dataset.idx);
                handleRecommendOthers(idx);
            }
            
            else if (e.target.closest(".reply-btn")) {
                const idx = parseInt(e.target.closest(".reply-btn").dataset.idx);
                handleReplyRecommendation(idx);
            }
            
else if (e.target.closest(".link-btn")) {
    const idx = parseInt(e.target.closest(".link-btn").dataset.idx);
    const job = window.profile.workExperiences[idx];
    const user = window.profile;
    const t = getTranslationFunction();

    const inviteModal = document.getElementById("inviteModal");
    const messageTextarea = document.getElementById("inviteTextarea");
    const templateButtonsContainer = document.getElementById("message-templates");
    const inviteCancelBtn = document.getElementById("inviteCancelBtn");
    const inviteSaveBtn = document.getElementById("inviteSaveBtn");
    const previewLinkEl = document.getElementById("invitePreviewLink");

    if (!inviteModal || !messageTextarea || !templateButtonsContainer || !inviteSaveBtn) {
        console.error("‚ùå ÈÇÄË´ã Modal ÁöÑÈÉ®ÂàÜÈóúÈçµÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÁÑ°Ê≥ïÈñãÂïü„ÄÇ");
        showToast("ÈÇÄË´ãÂäüËÉΩÊö´ÊôÇÁÑ°Ê≥ï‰ΩøÁî®ÔºåË´ãÁ®çÂæåÂÜçË©¶");
        return;
    }

    const generatePreviewUrl = () => {
        const message = messageTextarea.value.trim();
        const jobId = encodeURIComponent(job.id);
        const encMsg = encodeURIComponent(message);
        const lang = localStorage.getItem("lang") || "zh-Hant";
        
        return `${location.origin}/pages/recommend-form.html` +
            `?userId=${window.profile.userId}` +
            `&jobId=${jobId}` +
            `&message=${encMsg}` +
            `&lang=${lang}` +
            `&invitedBy=${window.profile.userId}`;
    };

    const updatePreviewLink = () => {
        if (previewLinkEl) {
            const url = generatePreviewUrl();
            previewLinkEl.setAttribute("href", url);
            previewLinkEl.title = url;
            previewLinkEl.textContent = t('profileDashboard.previewLink') || 'üîç È†êË¶ΩÊé®Ëñ¶Ë°®ÂñÆ';
        }
    };
    
    const templates = [
        {
            name: t("profileDashboard.inviteTemplates.inviteSenior.name"),
            message: t("profileDashboard.inviteTemplates.inviteSenior.message", {
                company: job.company || t('profileDashboard.unknownCompany'),
                userName: user.name,
                "Â∞çÊñπÂßìÂêç": "{Â∞çÊñπÂßìÂêç}"
            })
        },
        {
            name: t("profileDashboard.inviteTemplates.invitePeer.name"),
            message: t("profileDashboard.inviteTemplates.invitePeer.message", {
                company: job.company || t('profileDashboard.unknownCompany'),
                userName: user.name,
                "Â∞çÊñπÂßìÂêç": "{Â∞çÊñπÂßìÂêç}"
            })
        },
        {
            name: t("profileDashboard.inviteTemplates.inviteJunior.name"),
            message: t("profileDashboard.inviteTemplates.inviteJunior.message", {
                company: job.company || t('profileDashboard.unknownCompany'),
                userName: user.name,
                "Â∞çÊñπÂßìÂêç": "{Â∞çÊñπÂßìÂêç}"
            })
        }
    ];

    templateButtonsContainer.innerHTML = '';
    templates.forEach(template => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'template-btn';
        button.textContent = template.name;
        button.onclick = () => {
            messageTextarea.value = template.message;
            updatePreviewLink();
        };
        templateButtonsContainer.appendChild(button);
    });
    
    if (inviteCancelBtn) {
        inviteCancelBtn.onclick = () => inviteModal.close();
    }
    
    messageTextarea.addEventListener("input", updatePreviewLink);
    
    if (inviteSaveBtn) {
        inviteSaveBtn.onclick = async () => {
            const message = messageTextarea.value.trim();
            if (!message) {
                showToast(t('profileDashboard.inviteEmpty'));
                return;
            }

            try {
                const inviteRef = await db.collection("invites").add({
                    userId: window.profile.userId,
                    jobId: job.id,
                    message: message,
                    lang: localStorage.getItem("lang") || "zh-Hant",
                    invitedBy: window.profile.userId,
                    createdAt: new Date()
                });

                const finalLink = `${location.origin}/pages/recommend-form.html?inviteId=${inviteRef.id}`;
                
                let copySuccess = false;
                if (navigator.clipboard && window.isSecureContext) {
                    try {
                        await navigator.clipboard.writeText(finalLink);
                        copySuccess = true;
                    } catch (err) { /* fallback */ }
                }
                
                if (!copySuccess) {
                    const tempInput = document.createElement('input');
                    tempInput.value = finalLink;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    copySuccess = document.execCommand('copy');
                    document.body.removeChild(tempInput);
                }
                
                if (copySuccess) {
                    showToast(t('profileDashboard.inviteLinkCopied') || '‚úÖ ÈÇÄË´ãÈÄ£ÁµêÂ∑≤Ë§áË£ΩÔºÅ');
                    inviteModal.close();
                } else {
                    showManualCopyModal(finalLink);
                }

            } catch (err) {
                console.error("‚ùå Âª∫Á´ãÈÇÄË´ãÂ§±Êïó:", err);
                showToast(t('profileDashboard.inviteCreateFailed') || '‚ùå Âª∫Á´ãÈÇÄË´ãÂ§±Êïó');
            }
        };
    }

    messageTextarea.value = "";
    updatePreviewLink();

    inviteModal.showModal();

}
});
    }
}
// üéØ Á∂ÅÂÆöÂ∑•‰ΩúÁ∂ìÊ≠∑Ë°®ÂñÆ‰∫ã‰ª∂
function bindExperienceFormEvents() {
    const expForm = document.getElementById("expForm");
    const expCancelBtn = document.getElementById("expCancelBtn");
    if(expCancelBtn){
        expCancelBtn.onclick = () => {
            unlockAllFields();
            document.getElementById("expModal").close();
        }
    }
    if (expForm) {
        expForm.onsubmit = async (e) => {
            e.preventDefault();
            
            const companyInp = document.getElementById("companyInput");
            const positionInp = document.getElementById("positionInput");
            const startY = document.getElementById("startYear");
            const startM = document.getElementById("startMonth");
            const endY = document.getElementById("endYear");
            const endM = document.getElementById("endMonth");
            const stillChk = document.getElementById("stillWorking");
            const descInp = document.getElementById("descInput");
            
            const company = companyInp?.value.trim();
            const position = positionInp?.value.trim();
            const startYear = startY?.value;
            const startMonth = startM?.value;
            const endYear = stillChk?.checked ? "" : (endY?.value || "");
            const endMonth = stillChk?.checked ? "" : (endM?.value || "");
            const description = descInp?.value.trim();

            if (!company || !position || !startYear || !startMonth) {
                showToast(t('profileDashboard.requiredFieldsEmpty'));
                return;
            }

            const startDate = `${startYear}-${startMonth}`;
            const endDate = (endYear && endMonth) ? `${endYear}-${endMonth}` : "";

            const jobData = {
                id: editIdx === -1 ? Date.now().toString() : window.profile.workExperiences[editIdx].id,
                company,
                position,
                startDate,
                endDate,
                description,
                givenCount: editIdx === -1 ? 0 : (window.profile.workExperiences[editIdx].givenCount || 0),
                recommendations: editIdx === -1 ? [] : (window.profile.workExperiences[editIdx].recommendations || [])
            };

            if (editIdx === -1) {
                window.profile.workExperiences.push(jobData);
            } else {
                window.profile.workExperiences[editIdx] = jobData;
            }

            await saveProfile();
            await loadUserRecommendations(window.profile.userId);
            
            const experienceListContainer = document.getElementById("experienceList");
            if (experienceListContainer) {
                renderExperienceCardsWithReply(experienceListContainer, window.profile);
            }
            
            document.getElementById("expModal").close();
            showToast(editIdx === -1 ? t('profileDashboard.addSuccess') : t('profileDashboard.editSuccess'));
            unlockAllFields();
        };
    }
}

// üéØ Á∂ÅÂÆö Modal ÈóúÈñâ‰∫ã‰ª∂
function bindModalCloseEvents() {
    const expCancelBtn = document.getElementById("expCancelBtn");
    if (expCancelBtn) {
        expCancelBtn.onclick = () => {
            document.getElementById("expModal").close();
            unlockAllFields();
        };
    }
}

// ÂáΩÂºè‰∏âÔºöÁ∂ÅÂÆöÊñ∞Áî®Êà∂ÂºïÂ∞éÂΩàÁ™óÁöÑ‰∫ã‰ª∂
function bindOnboardingEvents() {
    const onboardingForm = document.getElementById('onboardingForm');
    if (onboardingForm) {
        // Á¢∫‰øùÂè™Á∂ÅÂÆö‰∏ÄÊ¨°
        onboardingForm.removeEventListener('submit', handleOnboardingSubmit);
        onboardingForm.addEventListener('submit', handleOnboardingSubmit);
    }
}

// üÜï Âú®Ê™îÊ°àÊúÄÂæåÊñ∞Â¢ûÊâãÂãïË§áË£Ω Modal ÂáΩÊï∏
function showManualCopyModal(linkToCopy) {
    let copyModal = document.getElementById("manualCopyModal");
    
    if (!copyModal) {
        copyModal = document.createElement("dialog");
        copyModal.id = "manualCopyModal";
        copyModal.className = "modal";
        
        copyModal.innerHTML = `
            <div class="modal-content" style="max-width: 500px;">
                <h3>${t('profileDashboard.manualCopyTitle') || 'üìã ÊâãÂãïË§áË£ΩÈÄ£Áµê'}</h3>
                <p style="margin-bottom: 1rem; color: #666;">
                    ${t('profileDashboard.manualCopyDesc') || 'Ëá™ÂãïË§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïË§áË£Ω‰ª•‰∏ãÈÄ£ÁµêÔºö'}
                </p>
                <div style="display: flex; gap: 8px; margin-bottom: 1rem;">
                    <input 
                        type="text" 
                        id="manualCopyInput" 
                        readonly 
                        style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                        value="${linkToCopy}"
                    />
                    <button 
                        type="button" 
                        id="manualCopyBtn" 
                        class="btn btn-primary"
                        style="white-space: nowrap;"
                    >
                        üìã ${t('profileDashboard.copyBtn') || 'Ë§áË£Ω'}
                    </button>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 8px;">
                    <button type="button" id="manualCopyCloseBtn" class="btn btn-secondary">
                        ${t('profileDashboard.close') || 'ÈóúÈñâ'}
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(copyModal);
        
        copyModal.addEventListener('click', (e) => {
            if (e.target.id === 'manualCopyBtn') {
                const input = document.getElementById('manualCopyInput');
                input.select();
                input.setSelectionRange(0, 99999);
                
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showToast('‚úÖ ÈÄ£ÁµêÂ∑≤Ë§áË£ΩÔºÅ');
                        copyModal.close();
                    } else {
                        showToast('Ë´ã‰ΩøÁî® Ctrl+C (Êàñ Cmd+C) Ë§áË£Ω');
                    }
                } catch (err) {
                    showToast('Ë´ãÊâãÂãïÈÅ∏ÂèñÊñáÂ≠ó‰∏¶Ë§áË£Ω (Ctrl+C)');
                }
            }
            
            else if (e.target.id === 'manualCopyCloseBtn') {
                copyModal.close();
            }
        });
    } else {
        const input = copyModal.querySelector('#manualCopyInput');
        if (input) input.value = linkToCopy;
    }
    
    copyModal.showModal();
    
    setTimeout(() => {
        const input = document.getElementById('manualCopyInput');
        if (input) {
            input.focus();
            input.select();
        }
    }, 100);
}
// ========================================
// 8Ô∏è‚É£ Á®ãÂºèÁ¢ºÁµêÊùüÊ®ôË®ò
// ========================================

console.log("‚úÖ profile-dashboard.js ËºâÂÖ•ÂÆåÊàê");
console.log("üìã ÂèØÁî®ÂáΩÂºè:", {
    Ê∏≤ÊüìÂáΩÂºè: ['renderUserLevel', 'renderBasicInfo', 'renderBioSection', 'renderExperienceCardsWithReply'],
    Ê•≠ÂãôÈÇèËºØ: ['handleRecommendOthers', 'handleReplyRecommendation', 'loadUserRecommendations'],
    ‰∫ã‰ª∂ËôïÁêÜ: ['bindProfileEditEvents', 'bindReplyModalEvents', 'initializeReplyOptionsModal'],
    Â∑•ÂÖ∑ÂáΩÂºè: ['t', 'showToast', 'smartOpenRecommendation', 'debugRecommendationData']
});