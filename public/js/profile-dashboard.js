// public/js/profile-dashboard.js
import { i18n } from "./i18n.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
import { firebaseConfig } from "./firebase-config.js";

// ÂàùÂßãÂåñ Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

document.addEventListener("DOMContentLoaded", () => {
  // Â§öË™û
  const lang = localStorage.getItem("lang") || "en";
  const t    = i18n[lang] || i18n.en;

  // ÂÖÉ‰ª∂Â∞çÊáâ
  const nameSection      = document.getElementById("nameSection");
  const chineseNameInput = document.getElementById("chineseNameInput");
  const englishNameInput = document.getElementById("englishNameInput");
  const basicInfo        = document.getElementById("basicInfo");
  const bioText          = document.getElementById("bioText");
  const editBioBtn       = document.getElementById("editBioBtn");
  const bioModal         = document.getElementById("bioModal");
  const bioForm          = document.getElementById("bioForm");
  const bioTextarea      = document.getElementById("bioTextarea");

  const list             = document.getElementById("experienceList");
  const addBtn           = document.getElementById("addBtn");
  const expModal         = document.getElementById("expModal");
  const expForm          = document.getElementById("expForm");
  const modalTitle       = document.getElementById("modalTitle");

  const companyInp       = document.getElementById("companyInput");
  const positionInp      = document.getElementById("positionInput");
  const startY           = document.getElementById("startYear");
  const startM           = document.getElementById("startMonth");
  const endY             = document.getElementById("endYear");
  const endM             = document.getElementById("endMonth");
  const stillChk         = document.getElementById("stillWorking");
  const descInp          = document.getElementById("descInput");

  const inviteModal       = document.getElementById("inviteModal");
  const inviteTextarea    = document.getElementById("inviteTextarea");
  const inviteStyleSelect = document.getElementById("inviteStyleSelect");
  const inviteCancelBtn   = document.getElementById("inviteCancelBtn");
  const inviteSaveBtn     = document.getElementById("inviteSaveBtn");

  // Êö´Â≠ò
  let profile = { userId:"", chineseName:"", englishName:"", bio:"", workExperiences:[] };
  let editIdx, currentJobIndex, currentCompany, currentDefaultMsg, currentInviteStyle;

  // ===== Â∑•ÂÖ∑ÂáΩÂºè =====
  function populateYearMonth() {
    const now = new Date(), thisYear = now.getFullYear();
    let yrs = ['<option value="">--</option>'], mos = ['<option value="">--</option>'];
    for (let y = thisYear-40; y <= thisYear; y++) yrs.push(`<option>${y}</option>`);
    for (let m = 1; m <= 12; m++) {
      const mm = String(m).padStart(2,"0");
      mos.push(`<option value="${mm}">${m}</option>`);
    }
    startY.innerHTML = endY.innerHTML = yrs.join("");
    startM.innerHTML = endM.innerHTML = mos.join("");
    stillChk.addEventListener("change", () => {
      endY.disabled = endM.disabled = stillChk.checked;
      if (stillChk.checked) endY.value = endM.value = "";
    });
  }

  function renderStaticText() {
    document.querySelectorAll("[data-i18n]").forEach(el => {
      const key = el.getAttribute("data-i18n");
      if (t[key] != null) el.textContent = t[key];
    });
  }

  async function saveProfile() {
    if (!profile.userId) return;
    await setDoc(doc(db, "users", profile.userId), profile);
  }

  function renderBasic() {
    basicInfo.innerHTML = `
      <h1>${profile.chineseName || ""}</h1>
      ${profile.englishName ? `<p>${profile.englishName}</p>` : ""}
      <p>${profile.workExperiences.length} ${t.workExperiences}</p>`;
  }

  function renderBio() {
    bioText.textContent = profile.bio || t.noBio;
  }
  console.log("Âêà‰ΩµÂæåÁöÑ experiences:", profile.workExperiences);
  function renderExperienceCards() {
    list.innerHTML = "";
    const grouped = {};
    profile.workExperiences.sort((a,b)=>b.startDate.localeCompare(a.startDate))
      .forEach(job=> (grouped[job.company] = grouped[job.company]||[]).push(job));
    Object.entries(grouped).forEach(([comp,jobs])=>{
      const wrap = document.createElement("div");
      wrap.className = "company-card";
      wrap.innerHTML = `<div class="company-title">${comp}</div>`;
      jobs.forEach(job=>{
        const idx = profile.workExperiences.indexOf(job);
        const hasRec = !!job.recommendations?.length;
        const recHTML = hasRec 
          ? job.recommendations.map(r=>`
            <div class="rec-card">
              <span class="name">${r.name}</span>
              <span class="meta">Ôºà${r.relation}Ôºâ</span><br>${r.content}
            </div>`).join("")
          : "";
        wrap.insertAdjacentHTML("beforeend", `
          <div class="role-card">
            <strong>${job.position}</strong>
            ${hasRec?`<span class="lock-tip">üîí</span>`:""}
            <button class="link-btn" data-idx="${idx}">üîó</button>
            <button class="edit-btn" data-idx="${idx}">üìù</button>
            <button class="del-btn" data-idx="${idx}">üóëÔ∏è</button>
            <div>${job.startDate} ÔΩû ${job.endDate||t.currentlyWorking}</div>
            ${job.description?`<div>${job.description}</div>`:""}
            ${recHTML}
          </div>`);
      });
      list.appendChild(wrap);
    });
  }

  function showToast(msg) {
    const d = document.createElement("div");
    d.className = "toast";
    d.textContent = msg;
    document.body.appendChild(d);
    setTimeout(()=>d.remove(),3000);
  }

  // ===== Áõ£ËÅΩÁôªÂÖ•ÁãÄÊÖã & ÂàùÂßãÊ∏≤Êüì =====
  onAuthStateChanged(auth, async user => {
    if (!user) return location.href = "/login.html";
    profile.userId = user.uid;
    // üè∑Ô∏è ÊòØÂê¶Áî®ÈÅé sessionStorage ÁöÑÈ†êÂ°´ÂäüËÉΩ
    let prefillUsed = false;


    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);
    if (snap.exists()) {
    profile = snap.data();
    // ‚Äî‚Äî ‰∏çË´ñ profile ÊòØÂê¶Â≠òÂú®ÔºåÈÉΩÂÖàÊ™¢Êü• sessionStorage Ë£°ÁöÑ prefillName ‚Äî‚Äî

  
      // === üî• ‰øÆÊ≠£ workExperiences ‰∏çÊòØÈô£ÂàóÁöÑÊÉÖÊ≥Å ===
      if (!Array.isArray(profile.workExperiences)) {
        const values = Object.values(profile.workExperiences || {});
        console.warn(`‚ö†Ô∏è [${profile.userId}] workExperiences ÈùûÈô£ÂàóÔºåËá™ÂãïËΩâÊèõÁÇ∫Èô£ÂàóÔºö`, values);
        profile.workExperiences = values;
      }
    } else {
      localStorage.removeItem("profile");
      profile = {
        userId: user.uid, chineseName:"", englishName:"", bio:"", workExperiences:[]
      };
      await setDoc(ref, profile);
    }
    // ‚Äî‚Äî ‰∏çË´ñÊñá‰ª∂Â≠ò‰∏çÂ≠òÂú®ÔºåÈÉΩÂÖàÊ™¢Êü• sessionStorage Ë£°ÁöÑ prefillName ‚Äî‚Äî 
    const prefillName = sessionStorage.getItem("prefillName");
    if (prefillName) {
      // Â°´ÂÖ•„Äå‰∏≠ÊñáÂßìÂêç„ÄçËº∏ÂÖ•Ê°Ü
      const nameInput = document.getElementById("chineseNameInput");
      if (nameInput) {
        nameInput.value = prefillName;
        prefillUsed = true;
      }
      // Ê∏ÖÊéâÔºåÈÅøÂÖç‰∏ãÊ¨°ÂèàËá™ÂãïÂ∏∂ÂÖ•
      sessionStorage.removeItem("prefillName");
      // Áõ¥Êé•ÈñãÂïü„ÄåÁ¨¨‰∏ÄÊ¨°Â°´Ê™îÊ°à„ÄçÁöÑ Modal
      openModalForAdd(true);
    }
// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

    // ‚Ä¶ ËÆÄÂèñ profile ‰∏¶ normalize ‰πãÂæå ‚Ä¶
    profile.workExperiences = profile.workExperiences||[];
    profile.workExperiences.forEach(j=>{ if (!j.endDate) j.endDate=""; });
    // ‚Ä¶ ËÆÄÂèñ profile ‰∏¶ normalize ‰πãÂæåÔºåÂÖàÊää recommendations Ê∏ÖÁ©∫ÔºåÈÅøÂÖçÈáçË§á ‚Ä¶
    profile.workExperiences = profile.workExperiences||[];
    profile.workExperiences.forEach(j => {
      // 1. Áµ±‰∏Ä endDate
      if (!j.endDate) j.endDate = "";
      // 2. Ê∏ÖÁ©∫‰∏ä‰∏ÄËº™Âêà‰ΩµÁöÑ recommendations
      j.recommendations = [];
    });

    // üî• ËÆÄÂèñ recommendations Â≠êÈõÜÂêàÔºå‰∏¶Áî® jobId Âêà‰ΩµÂà∞Â∞çÊáâÂ∑•‰Ωú
    const recColRef   = collection(db, "users", user.uid, "recommendations");
    const recSnapshot = await getDocs(recColRef);
    recSnapshot.forEach(docSnap => {
      const rec = docSnap.data();
      // ÊâæÂà∞ id Á¨¶ÂêàÁöÑÈÇ£Á≠ÜÂ∑•‰Ωú
      const job = (profile.workExperiences || []).find(j => j.id === rec.jobId);
      if (job) {
        job.recommendations = job.recommendations || [];
        job.recommendations.push(rec);
      }
    });    
    // ÂÜçÂëºÂè´ renderExperienceCards()
    populateYearMonth();
    renderStaticText();
    renderBasic();
    renderBio();
    renderExperienceCards();

    // Êü•ÁúãÁ∏ΩË¶ΩÊåâÈàï
    if (addBtn) {
      const btn = document.createElement("a");
      btn.href   = `recommend-summary.html?userId=${profile.userId}&jobIndex=0`;
      btn.target = "_blank";
      btn.className = "cta-btn";
      btn.textContent = t.viewSummaryAll;
      addBtn.insertAdjacentElement("afterend", btn);
    }

    // Á¨¨‰∏ÄÊ¨° fill vs ÁÑ°Á∂ìÊ≠∑ÈÉΩË¶ÅÈñã Modal
    if (!snap.exists()) {
      openModalForAdd(true);
    } else if (!profile.workExperiences.length && !prefillUsed) {
    // Âè™ÊúâÂú®Ê≤íÊúâÈ†êÂ°´ÈÅéÂßìÂêçÊôÇÔºåÊâçÈñãÔºàÂ°´Á∂ìÊ≠∑ÔºâÊ®°Âºè
      openModalForAdd(false);
    }

    // ===== ÊâÄÊúâ‰∫ã‰ª∂Á∂ÅÂÆöÊîæÂú®ÈÄôË£° =====

    // Á∑®ËºØ Bio
    editBioBtn.onclick = () => {
      bioTextarea.value = profile.bio||"";
      bioModal.showModal();
    };
    bioForm.onsubmit = async e => {
      e.preventDefault();
      profile.bio = bioTextarea.value.trim();
      await saveProfile();
      renderBio();
      bioModal.close();
    };

    // Êñ∞Â¢û / Á∑®ËºØ Experience
    addBtn.onclick = () => openModalForAdd(false);
    expForm.onsubmit = async e => {
      e.preventDefault();
    
      // ‚òÖ ÂàùÊ¨°Â°´ÂßìÂêç
      if (!profile.chineseName && chineseNameInput.value.trim()) {
        profile.chineseName = chineseNameInput.value.trim();
        profile.englishName = englishNameInput.value.trim();
        renderBasic();
      }
    
      const pad = v => v.padStart(2, "0");
      const startDate = `${startY.value}-${pad(startM.value)}`;
    
      // È©óË≠âÁµêÊùüÊó•ÊúüÔºöÂè™Êúâ„ÄåÊú™ÂãæÈÅ∏‰ªçÂú®ËÅ∑„ÄçÊâçÈúÄË¶ÅÊ™¢Êü•
      let endDate = "";
      if (!stillChk.checked) {
        // 1. Á¢∫Ë™çÊúâÈÅ∏Âπ¥/Êúà
        if (!endY.value || !endM.value) {
          showToast(t.selectEnd);
          return;
        }
        // 2. ËΩâÊàê Date Áâ©‰ª∂ÂÜçÊØîÂ§ßÂ∞è
        const startObj = new Date(`${startY.value}-${pad(startM.value)}-01`);
        const endObj   = new Date(`${endY.value}-${pad(endM.value)}-01`);
        const today    = new Date();
    
        // 3. ÁµêÊùü‰∏çËÉΩÊó©ÊñºÈñãÂßã
        if (endObj < startObj) {
          showToast(t.errEndBeforeStart);
          return;
        }
        // 4. ÁµêÊùü‰∏çËÉΩË∂ÖÈÅé‰ªäÂ§©
        if (endObj > today) {
          showToast(t.errEndAfterToday);
          return;
        }
        // 5. ÂêàÊ≥ïÊâçÁµÑÂõûÂ≠ó‰∏≤
        endDate = `${endY.value}-${pad(endM.value)}`;
      }
    
      // ÁµÑ payload
      const payload = {
      id: editIdx===null ? crypto.randomUUID() : profile.workExperiences[editIdx].id,
      company:     companyInp.value.trim(),
      position:    positionInp.value.trim(),
      startDate,
      endDate,
      description: descInp.value.trim(),
      recommendations: profile.workExperiences[editIdx]?.recommendations || []
  };

      if (editIdx==null) profile.workExperiences.push(payload);
      else {
        const job = profile.workExperiences[editIdx];
        if (job.recommendations?.length) job.description = payload.description;
        else Object.assign(job, payload);
      }

      await saveProfile();
      renderExperienceCards();
      renderBasic();
      expModal.close();
    };

    // Âà™Èô§ / Á∑®ËºØ / Ë§áË£ΩÊé®Ëñ¶
    list.addEventListener("click", e => {
      const idx = +e.target.dataset.idx;
      if (e.target.matches(".del-btn")) {
        if (confirm(t.deleteConfirm)) {
          profile.workExperiences.splice(idx,1);
          saveProfile().then(renderExperienceCards);
          showToast(t.deleteToast);
        }
      }
      else if (e.target.matches(".edit-btn")) openModalForEdit(idx);
      else if (e.target.matches(".link-btn")) {
        currentJobIndex = idx;
        currentCompany  = profile.workExperiences[idx].company;
        inviteStyleSelect.value = "warmth";
        currentInviteStyle = "warmth";
        currentDefaultMsg  = (t[`defaultInvite_warmth`]||"")
          .replace("{{company}}", currentCompany);
        inviteTextarea.value = currentDefaultMsg;
        inviteModal.showModal();
      }
    });

    // ÈÇÄË´ã Modal ÊåâÈàï
    inviteCancelBtn.onclick = ()=>inviteModal.close();
    inviteSaveBtn.onclick = ()=>{
      currentInviteStyle = inviteStyleSelect.value;
      const msg = inviteTextarea.value.trim()||currentDefaultMsg;
      const jobId = profile.workExperiences[currentJobIndex].id;
      const url = `${location.origin}/recommend-form.html`
               + `?userId=${profile.userId}`
               + `&jobId=${encodeURIComponent(jobId)}`
               + `&message=${encodeURIComponent(msg)}`
               + `&style=${currentInviteStyle}`;

      navigator.clipboard.writeText(url)
        .then(()=>showToast(t.linkCopied))
        .catch(()=>showToast(t.linkCopyFailed));
      inviteModal.close();
    };

    // ÊâìÈñã Add/Edit Modal
function openModalForAdd(isFirst = false) {
  editIdx = null;
  // È°ØÁ§∫„ÄåÂßìÂêç„ÄçÊ¨Ñ‰ΩçÂè™Âú®È¶ñÊ¨°Â°´Ê™îÊ°àÊôÇ
  nameSection.hidden = !isFirst;

  // Â¶ÇÊûúÊòØ„ÄåÊñ∞Â¢ûÁ∂ìÊ≠∑„ÄçÊµÅÁ®ãÔºåÊâçÈáçÁΩÆË°®ÂñÆ
  if (!isFirst) {
    expForm.reset();
  }

  // È¶ñÊ¨°Â°´Ê™îÊ°àÊ®°Âºè‰∏ãÔºåÊ∏≤ÊüìË™ûÁ≥ªÊñáÂ≠ó
  if (isFirst) {
    renderStaticText();
  }

  // Ê®ôÈ°å
  modalTitle.textContent = isFirst
    ? t.addProfileTitle
    : t.addExperienceTitle;

  // ÊúüÈñìÊ¨Ñ‰ΩçÈáçÁΩÆ
  stillChk.checked = false;
  endY.disabled = endM.disabled = false;

  // Âπ¥Êúà‰∏ãÊãâÈÅ∏ÂñÆ
  populateYearMonth();

  // ÈñãÂïü Modal
  expModal.showModal();
}


    function openModalForEdit(idx) {
      editIdx = idx;
      const job = profile.workExperiences[idx];
      const locked = !!job.recommendations?.length;
      nameSection.hidden = true;
      modalTitle.textContent = locked
        ? t.editDescriptionTitle
        : t.editExperienceTitle;
      companyInp.value  = job.company;
      positionInp.value = job.position;
      startY.value      = job.startDate.slice(0,4);
      startM.value      = job.startDate.slice(5,7);
      if (job.endDate) {
        stillChk.checked = false;
        endY.disabled = endM.disabled = false;
        endY.value = job.endDate.slice(0,4);
        endM.value = job.endDate.slice(5,7);
      } else {
        stillChk.checked = true;
        endY.disabled = endM.disabled = true;
      }
      descInp.value = job.description||"";
      if (locked) lockCore(); else unlockCore();
      expModal.showModal();
    }

    function lockCore() {
      [nameSection,chineseNameInput,englishNameInput,
       companyInp,positionInp,startY,startM,endY,endM,stillChk]
      .forEach(el=>el.disabled=true);
    }
    function unlockCore() {
      [nameSection,chineseNameInput,englishNameInput,
       companyInp,positionInp,startY,startM,endY,endM,stillChk]
      .forEach(el=>el.disabled=false);
    }
  });
});
