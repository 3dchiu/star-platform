// functions/index.js
require("dotenv").config();// ğŸ”½ åˆå§‹åŒ–è¨­å®šï¼šç’°å¢ƒè®Šæ•¸ã€SendGridã€Firebase Admin
const { onDocumentCreated } = require("firebase-functions/v2/firestore");
const functions = require("firebase-functions");
const sgMail = require("@sendgrid/mail");
sgMail.setApiKey(process.env.SENDGRID_KEY);
const admin = require("firebase-admin");

admin.initializeApp();

// ğŸ”½ å¤šèªç³»ä¿¡ä»¶å…§å®¹è¨­å®šï¼ˆé€šçŸ¥æ¨è–¦äººã€æ­¡è¿ä¿¡ï¼‰
const i18nMessages = {
  notifyRecommendation: {
    zh: {
      subject: (name) => `æ„Ÿè¬ä½ å° ${name} çš„æ¨è–¦ ğŸ’«`,
      text: (recommenderName, recommendeeName) => `Hi ${recommenderName}ï¼Œ

è¬è¬ä½ ç‚º ${recommendeeName} å¯«ä¸‹é€™æ®µæ¨è–¦ã€‚
é€™ä¸åªæ˜¯ä¸€å°ä¿¡ï¼Œè€Œæ˜¯ä»–è·æ¶¯è£¡ï¼Œä¸€ä»½é›£å¾—çš„è‚¯å®šã€‚

æˆ–è¨±ä½ é‚„è¨˜å¾—ï¼Œç•¶æ™‚ä½ å€‘ä¸€èµ·åŠªåŠ›å®Œæˆçš„é‚£å€‹å°ˆæ¡ˆï¼Œ
æˆ–æ˜¯åœ¨æŸæ®µä½æ½®æ™‚ï¼Œä»–å°ä½ çš„æ”¯æŒèˆ‡åˆä½œã€‚

ä½ çš„é€™æ®µè©±ï¼Œæœƒæˆç‚ºä»–æ—¥å¾Œå›é¡§è·æ¶¯æ™‚ï¼Œä¸€é“æº«æŸ”çš„å…‰ã€‚

å¦‚æœä½ ä¹Ÿæƒ³è®“éå»åˆä½œéçš„å¤¥ä¼´ï¼ŒçŸ¥é“ä½ è¨˜å¾—ä»–å€‘çš„å¥½ï¼Œ
ä¹Ÿæ­¡è¿ä½ ç‚ºè‡ªå·±å»ºç«‹æ¨è–¦é ï¼Œæˆç‚ºé€™å€‹äº’ç›¸é»äº®çš„æ˜Ÿç³»çš„ä¸€å“¡ã€‚

ğŸŒŸ ç«‹å³å»ºç«‹æ¨è–¦é ï¼šhttps://galaxyz.ai/pages/login.html

è¬è¬ä½ ï¼Œè®“ä¿¡ä»»é–‹å§‹æµå‹•ã€‚  
Galaxyz åœ˜éšŠæ•¬ä¸Š`
    },
    en: {
      subject: (name) => `Thank you for recommending ${name} ğŸ’«`,
      text: (recommenderName, recommendeeName) => `Hi ${recommenderName},

Thank you for writing a recommendation for ${recommendeeName}.
This isn't just a message â€” it's a meaningful part of their career.

You might remember that project you worked on together,
or how they supported you through a challenging time.

Your words will become a warm light they carry as they look back on their journey.

If youâ€™d like to share similar memories with people you've worked with,
youâ€™re welcome to create your own recommendation page â€” and pass the light on.

ğŸŒŸ Start your own page: https://galaxyz.ai/pages/login.html

Thank you for helping trust move forward.  
Team Galaxyz`
    }
  },
  welcomeEmail: {
  zh: {
    subject: "æ­¡è¿åŠ å…¥ Galaxyzï¼ğŸŒŸ",
    text: (name) => `å—¨ ${name || "æœ‹å‹"}ï¼Œ

æ­¡è¿åŠ å…¥ Galaxyzï¼

åœ¨é€™å€‹å±¥æ­·å¯ä»¥è¢« AI ç”Ÿæˆçš„æ™‚ä»£ï¼Œ
æˆ‘å€‘æ›´æƒ³ç•™ä¸‹çš„ï¼Œæ˜¯é‚£äº›ç„¡æ³•è¢«å–ä»£çš„ç¬é–“ â€”â€”
ğŸŒŸåœ¨ä½ å‰›é€²å…¬å¸æ™‚ï¼Œé¡˜æ„ç‰½è‘—ä½ è·‘çš„å­¸é•·å§ï¼›
ğŸŒŸåœ¨ä½ çŠ¯éŒ¯æ™‚ï¼Œæ²’è²¬å‚™ä½ åè€Œå¹«ä½ æ“‹ä¸‹ç«ç·šçš„ä¸»ç®¡ï¼›
ğŸŒŸç¸½æ˜¯é»˜é»˜è£œä½ã€ä¸çˆ­åŠŸçš„åœ˜éšŠå¤¥ä¼´ï¼›
ğŸŒŸé›–ç„¶åªåˆä½œä¸‰å€‹æœˆï¼Œä½†å§‹çµ‚è¨˜å¾—ä½ åŠªåŠ›çš„å®¢æˆ¶ï¼›
ğŸŒŸé‚„æœ‰é‚£ä½ï¼Œå¹¾å¹´å‰çŸ­æš«åˆä½œéï¼Œä½†ä½ è‡³ä»Šä»è¨˜å¾—ä»–æœ‰å¤šå¯é ã€‚

å¦‚æœä½ é¡˜æ„ï¼Œç¾åœ¨å°±å¯«ä¸‹ä¸€å¥ä½ å°ä»–çš„æ„Ÿè¬å§ã€‚
é‚£å¥è©±å¯èƒ½å¾ˆç°¡å–®ï¼šã€Œè¬è¬ä½ ï¼Œè®“æˆ‘åœ¨ä½æ½®çš„æ™‚å€™ä¸å­¤å–®ã€‚ã€
ä½†å°æ–¹æ”¶åˆ°æ™‚ï¼Œæœƒè¦ºå¾—ï¼šã€ŒåŸä¾†æˆ‘åšéçš„é‚£äº›äº‹ï¼Œä½ éƒ½è¨˜å¾—ã€‚ã€

é€™ï¼Œå°±æ˜¯ Galaxyz æƒ³å¹«ä½ ç•™ä¸‹çš„æ±è¥¿ã€‚
ä¸æ˜¯ä¸€å°æµ®èª‡çš„æ¨è–¦ä¿¡ï¼Œè€Œæ˜¯ä¸€ä»½çœŸèª çš„è·æ¶¯å›æ†¶ã€‚

ä½ å¯ä»¥å¾é€™è£¡é–‹å§‹ï¼š
âœ… é‚€è«‹åˆä½œéçš„å¤¥ä¼´ï¼Œå¯«ä¸‹å°ä½ çš„æ¨è–¦  
âœ… ç‚ºé‚£äº›å¹«éä½ çš„äººï¼Œä¸»å‹•é€ä¸Šä¸€å¥ã€Œè¬è¬ä½ ã€  
âœ… å»ºç«‹å±¬æ–¼ä½ çš„è·æ¶¯ä¿¡ä»»ç¶²çµ¡ï¼Œç´¯ç©é‚£äº›æœ€çœŸå¯¦çš„åƒ¹å€¼

æˆ‘å€‘ç›¸ä¿¡ï¼š
å±¥æ­·æœƒéæ™‚ï¼Œä½†ä¿¡ä»»ä¸æœƒã€‚  
ä½ å€¼å¾—è¢«è¨˜å¾—ï¼Œä¹Ÿå€¼å¾—è¢«æ¨è–¦ã€‚

Galaxyz åœ˜éšŠæ•¬ä¸Š`
  },

    en: {
      subject: "Welcome to Galaxyz! ğŸŒŸ",
      text: (name) => `Hi ${name || "there"},

Welcome to Galaxyz!

In this era where rÃ©sumÃ©s can be generated by AI,
what we truly want to preserve are the irreplaceable moments â€”â€”

ğŸŒŸ The senior colleague who guided you when you first joined the company;  
ğŸŒŸ The manager who had your back when you made a mistake;  
ğŸŒŸ The teammate who quietly stepped up without seeking credit;  
ğŸŒŸ The client who only worked with you for three months, but never forgot your efforts;  
ğŸŒŸ And that person â€” the one you collaborated with years ago, and still remember for their reliability.

If you're willing, take a moment to write a simple thank-you to them now.  
It could be something as short as: "Thank you for being there when I was struggling."  
But when they receive it, theyâ€™ll feel: â€œSo you remembered what I did.â€

Thatâ€™s what Galaxyz is here for â€”  
Not to create flashy recommendation letters,  
but to preserve genuine career memories.

You can start from here:
âœ… Invite people you've worked with to write a recommendation for you  
âœ… Send a message of appreciation to those who've helped you  
âœ… Build your own trust-based career network, filled with real value

We believe:
RÃ©sumÃ©s will fade, but trust will last.  
You deserve to be remembered â€” and recommended.

Warmly,  
The Galaxyz Team`

    }
  }
};


// ğŸ”½ åŠŸèƒ½ 1ï¼šæ¨è–¦é€å‡ºå¾Œï¼Œè‡ªå‹•å¯„å‡ºæ„Ÿè¬ä¿¡ï¼ˆçµ¦æ¨è–¦äººï¼‰èˆ‡é€šçŸ¥ä¿¡ï¼ˆçµ¦è¢«æ¨è–¦äººï¼‰
// ğŸ“¥ ç›£è½è·¯å¾‘ï¼šusers/{userId}/recommendations/{recId}
// ğŸ“¤ å‹•ä½œï¼šå¯„é€ 2 å°ä¿¡ï¼ˆè¢«æ¨è–¦äººé€šçŸ¥ã€æ¨è–¦äººæ„Ÿè¬ä¿¡ï¼‰
exports.notifyOnRecommendationCreated = onDocumentCreated("users/{userId}/recommendations/{recId}", async (event) => {
  
    const snap = event.data;
    const data = snap.data();
    const userId = event.params.userId;
    const { name, email, content, jobId } = data;
  
    console.log(`ğŸ“£ æ–°æ¨è–¦ä¾†è‡ª ${name} (${email})ï¼Œé‡å°è·ç¼º ${jobId}`);
    // ğŸ” å˜—è©¦è®€å–è¢«æ¨è–¦è€…ï¼ˆuserIdï¼‰è³‡æ–™
    const userSnap = await admin.firestore().doc(`users/${userId}`).get();
    const user = userSnap.data();
    if (!user || !user.email) {
      console.error("âŒ æ‰¾ä¸åˆ°è¢«æ¨è–¦è€…è³‡æ–™");
      return null;
    }
  
    const recommendeeEmail = user.email;
    const recommendeeName = user.name || "Galaxyz ä½¿ç”¨è€…";
  
    try {  
      // ğŸ“¤ ä¿¡ä»¶ä¸€ï¼šé€šçŸ¥è¢«æ¨è–¦è€…æœ‰æ–°æ¨è–¦
      await sgMail.send({
        to: recommendeeEmail,
        from: {
            email: process.env.SENDER_EMAIL,
            name: process.env.SENDER_NAME          
        },
        subject: `âœ¨ ä½ æ”¶åˆ°ä¾†è‡ª ${name} çš„æ¨è–¦`,
        text: `${name} å‰›å‰›å®Œæˆäº†ä¸€ä»½æ¨è–¦çµ¦ä½ ã€‚\n\nå…§å®¹æ‘˜è¦ï¼š\n"${content}"\n\nğŸ‘‰ ç«‹åˆ»æŸ¥çœ‹ï¼šhttps://galaxyz.ai/pages/recommend-summary.html?userId=${userId}`,
        trackingSettings: {
            clickTracking: { enable: false, enableText: false }
          }
    });
          
      const lang = data.lang || "zh";  // å¾æ¨è–¦å…§å®¹ä¸­è®€å–èªç³»
      const subject = i18nMessages.notifyRecommendation[lang].subject(recommendeeName);
      const text = i18nMessages.notifyRecommendation[lang].text(name, recommendeeName);
      // ğŸ“¤ ä¿¡ä»¶äºŒï¼šå¯„æ„Ÿè¬ä¿¡çµ¦æ¨è–¦äººï¼ˆæ ¹æ“šèªç³»åˆ‡æ›å…§å®¹ï¼‰
      await sgMail.send({
        to: email,
        from: {
          email: process.env.SENDER_EMAIL,
          name: process.env.SENDER_NAME
        },
        subject,
        text,
        trackingSettings: {
          clickTracking: { enable: false, enableText: false }
        }
      });          
  
      console.log(`âœ… å·²æˆåŠŸå¯„å‡ºæ„Ÿè¬ä¿¡çµ¦æ¨è–¦äºº ${email}`);
    } catch (error) {
      console.error("âŒ SendGrid å¯„ä¿¡å¤±æ•—ï¼š", error);
    }
  
    return null;
  });

// ğŸ”½ åŠŸèƒ½ 2ï¼šæ¨è–¦äººå®Œæˆè¨»å†Šå¾Œï¼Œè‡ªå‹•è£œä¸Š recommenderId
// ğŸ“¥ ç›£è½è·¯å¾‘ï¼šusers/{userId}
// ğŸ“¤ å‹•ä½œï¼šè£œå¯«æ¨è–¦ç´€éŒ„çš„ recommenderIdã€åˆªé™¤ pendingUser
exports.onUserCreated_assignRecommenderId = onDocumentCreated("users/{userId}", async (event) => {
  const snap = event.data;
  const newUser = snap.data();
  const newUserId = event.params.userId;
  const email = newUser?.email;

  if (!email) {
    console.warn("âš ï¸ æ–°ä½¿ç”¨è€…ç¼ºå°‘ emailï¼Œç•¥é recommenderId é…å°");
    return;
  }

  console.log(`ğŸ§© æ–°ä½¿ç”¨è€…è¨»å†Šï¼š${email} (${newUserId})`);

  try {
    // ğŸ” æŸ¥æ‰¾ pendingUsers ä¸­ç¬¦åˆ email çš„ç´€éŒ„
    const pendingSnap = await admin.firestore()
      .collection("pendingUsers")
      .where("email", "==", email)
      .limit(1)
      .get();

    if (pendingSnap.empty) {
      console.log("ğŸ” æ²’æœ‰æ‰¾åˆ°å°æ‡‰çš„ pendingUser æ¨è–¦ç´€éŒ„");
      return;
    }

    const pendingData = pendingSnap.docs[0].data();
    const inviteId = pendingData?.inviteId;

    if (!inviteId) {
      console.warn("âš ï¸ æ‰¾åˆ° pendingUserï¼Œä½†ç¼ºå°‘ inviteIdï¼Œç•¥éæ›´æ–°");
      return;
    }

    // ğŸ” å¾ pendingUser æ‰¾å‡º inviteIdï¼ŒæŸ¥è©¢è©²æ¨è–¦ç´€éŒ„
    const recSnap = await admin.firestore()
      .collection(`users/${pendingData.userId}/recommendations`)
      .where("inviteId", "==", inviteId)
      .get();
    
    console.log(`ğŸ•µï¸â€â™€ï¸ æŸ¥æ‰¾åˆ°æ¨è–¦ç´€éŒ„å…± ${recSnap.size} ç­†ï¼Œå˜—è©¦è£œä¸Š recommenderId`);

    if (recSnap.empty) {
      console.log("â„¹ï¸ ç„¡éœ€è£œå¯« recommenderIdï¼šæ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ¨è–¦ç´€éŒ„");
      return;
    }

    for (const recDoc of recSnap.docs) {
      const recData = recDoc.data();
      if (!recData.recommenderId) {
        // âœ… å¯«å…¥ recommenderId
        await recDoc.ref.update({ recommenderId: newUserId });
        console.log(`âœ… å·²è£œä¸Š recommenderIdï¼š${recDoc.id}`);
      } else {
        console.log(`â„¹ï¸ å·²å­˜åœ¨ recommenderIdï¼š${recDoc.id}ï¼Œç•¥éæ›´æ–°`);
      }
    }

    // ğŸ§¹ æ¸…é™¤å·²å®Œæˆé…å°çš„ pendingUser
    await pendingSnap.docs[0].ref.delete();
    console.log(`ğŸ§¹ å·²åˆªé™¤ pendingUserï¼š${pendingSnap.docs[0].id}`);

  } catch (err) {
    console.error("âŒ è‡ªå‹•è£œ recommenderId ç™¼ç”ŸéŒ¯èª¤ï¼š", err);
  }

  return;
});

// ğŸ”½ åŠŸèƒ½ 3ï¼šæ–°ä½¿ç”¨è€…è¨»å†Šå¾Œï¼Œè‡ªå‹•å¯„é€æ­¡è¿ä¿¡
// ğŸ“¥ ç›£è½è·¯å¾‘ï¼šusers/{userId}
// ğŸ“¤ å‹•ä½œï¼šæ ¹æ“šèªç³»å¯„é€å¤šèªæ­¡è¿ä¿¡
exports.sendWelcomeEmailOnUserDocCreated = onDocumentCreated("users/{userId}", async (event) => {
  const snap = event.data;
  const user = snap.data();
  const email = user?.email;
  const lang = user?.lang;

    // âœ… è‹¥æœ‰ inviteCodeï¼Œå‰‡è‡ªå‹•ç´¯åŠ ä½¿ç”¨æ¬¡æ•¸
  const inviteCode = user?.inviteCode;
  if (inviteCode) {
    try {
      const inviteRef = admin.firestore().collection("inviteCodes").doc(inviteCode);
      const inviteSnap = await inviteRef.get();
      if (inviteSnap.exists) {
        const currentCount = inviteSnap.data().usageCount || 0;
        await inviteRef.update({ usageCount: currentCount + 1 });
        console.log(`ğŸ”¢ é‚€è«‹ç¢¼ ${inviteCode} ä½¿ç”¨æ¬¡æ•¸ +1 æˆåŠŸ`);
      } else {
        console.warn(`âš ï¸ æ‰¾ä¸åˆ° inviteCodeï¼š${inviteCode}`);
      }
    } catch (err) {
      console.error("âŒ ç´¯åŠ  inviteCode ä½¿ç”¨æ¬¡æ•¸å¤±æ•—ï¼š", err);
    }
  }
  
  // ğŸ” é©—è­‰ email æ˜¯å¦å­˜åœ¨ï¼Œå†æ±ºå®šæ˜¯å¦å¯„ä¿¡
  if (!email) {
    console.warn("âš ï¸ ä½¿ç”¨è€…ç¼ºå°‘ emailï¼Œç•¥éæ­¡è¿ä¿¡");
    return;
  }

  const subject = i18nMessages.welcomeEmail[lang]?.subject || i18nMessages.welcomeEmail.en.subject;
  const text = i18nMessages.welcomeEmail[lang]?.text(user.displayName) || i18nMessages.welcomeEmail.en.text(user.displayName);

  const msg = {
    to: email,
    from: {
      email: process.env.SENDER_EMAIL,
      name: process.env.SENDER_NAME
    },
    subject,
    text,
    trackingSettings: {
      clickTracking: { enable: false, enableText: false }
    }
  };

  try {
    await sgMail.send(msg);
    console.log(`âœ… æ­¡è¿ä¿¡å·²å¯„å‡ºçµ¦ ${email}`);
  } catch (error) {
    console.error("âŒ å¯„é€æ­¡è¿ä¿¡å¤±æ•—ï¼š", error);
  }

  return;
});




